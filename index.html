<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± Phone Auction System v5.0 Ultimate</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        --primary: #7c3aed;
        --primary-dark: #6d28d9;
        --secondary: #ec4899;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #3b82f6;
        --dark: #1e293b;
        --light: #f8fafc;
        --gray: #64748b;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: var(--dark);
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        overflow: hidden;
        backdrop-filter: blur(10px);
    }

    /* Header */
    .header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: white;
        padding: 30px;
        position: relative;
        overflow: hidden;
    }

    .header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
        background-size: 20px 20px;
        transform: rotate(45deg);
        animation: float 20s linear infinite;
    }

    @keyframes float {
        0% { transform: rotate(45deg) translate(0, 0); }
        100% { transform: rotate(45deg) translate(20px, 20px); }
    }

    .header-content {
        position: relative;
        z-index: 1;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    .header h1 {
        font-size: 2em;
        font-weight: 800;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .sync-status {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255,255,255,0.2);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        backdrop-filter: blur(10px);
    }

    .sync-status.online {
        background: rgba(16, 185, 129, 0.3);
    }

    .sync-status.offline {
        background: rgba(239, 68, 68, 0.3);
    }

    .sync-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #fff;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.8; }
    }

    /* Lot Selector */
    .lot-selector {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        padding: 20px 30px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
    }

    .lot-selector-title {
        font-weight: 700;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .lot-tabs {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        flex: 1;
    }

    .lot-tab {
        padding: 8px 16px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
        font-size: 14px;
        position: relative;
    }

    .lot-tab:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .lot-tab.active {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        border-color: var(--primary);
    }

    .lot-tab.multi-select {
        background: linear-gradient(135deg, var(--info) 0%, #2563eb 100%);
        color: white;
        border-color: var(--info);
    }

    .lot-tab .badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: var(--danger);
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: 700;
    }

    .lot-actions {
        display: flex;
        gap: 10px;
    }

    /* Content */
    .content {
        padding: 30px;
    }

    /* Dashboard Cards */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .dashboard-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        border-left: 4px solid var(--primary);
        transition: all 0.3s;
    }

    .dashboard-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .dashboard-card .label {
        font-size: 12px;
        color: var(--gray);
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .dashboard-card .value {
        font-size: 28px;
        font-weight: 800;
        color: var(--dark);
        margin-top: 8px;
    }

    /* Tabs */
    .tabs {
        display: flex;
        gap: 4px;
        background: #f1f5f9;
        padding: 4px;
        border-radius: 16px;
        margin-bottom: 24px;
        overflow-x: auto;
    }

    .tab-btn {
        padding: 12px 20px;
        background: transparent;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        color: var(--gray);
        transition: all 0.3s;
        white-space: nowrap;
    }

    .tab-btn:hover {
        background: rgba(124, 58, 237, 0.1);
        color: var(--primary);
    }

    .tab-btn.active {
        background: white;
        color: var(--primary);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Tab Content */
    .tab-content {
        display: none;
        animation: fadeIn 0.5s;
    }

    .tab-content.active {
        display: block;
    }

    /* Sections */
    .section {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        border: 1px solid #f1f5f9;
    }

    .section-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    /* Forms */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    label {
        font-size: 13px;
        font-weight: 600;
        color: var(--gray);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    input, select, textarea {
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 15px;
        transition: all 0.3s;
        background: white;
    }

    input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1);
    }

    textarea {
        min-height: 100px;
        resize: vertical;
    }

    /* Buttons */
    .button-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        color: white;
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        color: white;
    }

    .btn-info {
        background: linear-gradient(135deg, var(--info) 0%, #2563eb 100%);
        color: white;
    }

    .btn-warning {
        background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        color: white;
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 13px;
    }

    /* Table */
    .table-container {
        overflow-x: auto;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    th {
        padding: 12px;
        text-align: left;
        font-weight: 700;
        font-size: 13px;
        color: var(--gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #e5e7eb;
    }

    td {
        padding: 12px;
        border-bottom: 1px solid #f1f5f9;
        font-size: 14px;
    }

    tbody tr:hover {
        background: #f8fafc;
    }

    tbody tr:last-child td {
        border-bottom: none;
    }

    /* Phone List Grid */
    .phone-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
        max-height: 400px;
        overflow-y: auto;
        padding: 12px;
        background: #f8fafc;
        border-radius: 12px;
    }

    .phone-item {
        background: white;
        padding: 12px;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
        text-align: center;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s;
        position: relative;
        cursor: pointer;
    }

    .phone-item:hover {
        transform: translateY(-2px);
        border-color: var(--primary);
        box-shadow: 0 4px 8px rgba(124, 58, 237, 0.2);
    }

    .phone-item.sold {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border-color: var(--success);
    }

    .phone-item .price {
        font-size: 11px;
        margin-top: 4px;
        opacity: 0.8;
    }

    .phone-item .remove-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 20px;
        height: 20px;
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        font-size: 12px;
        line-height: 1;
    }

    .phone-item:hover .remove-btn {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Charts */
    .chart-container {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        height: 400px;
    }

    /* Summary Grid */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 8px 24px rgba(124, 58, 237, 0.3);
        transition: all 0.3s;
    }

    .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 32px rgba(124, 58, 237, 0.4);
    }

    .summary-card h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        opacity: 0.95;
    }

    .summary-card .value {
        font-size: 36px;
        font-weight: 800;
        margin: 12px 0;
    }

    .summary-card .subtitle {
        font-size: 14px;
        opacity: 0.9;
    }

    /* Filter Section */
    .filter-section {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }

    .filter-label {
        font-weight: 600;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .lot-filter-chips {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .lot-chip {
        padding: 6px 12px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 13px;
        font-weight: 600;
    }

    .lot-chip:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .lot-chip.selected {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    /* Progress Bar */
    .progress-container {
        margin-bottom: 20px;
    }

    .progress-bar {
        width: 100%;
        height: 30px;
        background: #f1f5f9;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        width: 0%;
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }

    .progress-text {
        text-align: center;
        margin-top: 10px;
        color: var(--gray);
        font-size: 14px;
    }

    /* Input Method Tabs */
    .input-method-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .method-btn {
        flex: 1;
        padding: 12px 20px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        color: var(--gray);
        transition: all 0.3s;
    }

    .method-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .method-btn.active {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        border-color: var(--primary);
    }

    .input-method-content {
        display: none;
    }

    .input-method-content.active {
        display: block;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s;
    }

    .modal-content {
        background: white;
        margin: 5% auto;
        padding: 32px;
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        animation: slideDown 0.3s;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .modal-header h3 {
        font-size: 20px;
        font-weight: 700;
        color: var(--dark);
    }

    .close {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #f1f5f9;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: var(--gray);
        transition: all 0.3s;
    }

    .close:hover {
        background: var(--danger);
        color: white;
        transform: rotate(90deg);
    }

    /* Toast Notification */
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        z-index: 1001;
        display: none;
        animation: slideInRight 0.3s;
        max-width: 360px;
        border-left: 4px solid var(--success);
    }

    .toast.error {
        border-left-color: var(--danger);
    }

    .toast.warning {
        border-left-color: var(--warning);
    }

    .toast.info {
        border-left-color: var(--info);
    }

    .toast-content {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .toast-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .header h1 {
            font-size: 1.5em;
        }
        
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
        
        .phone-list {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }
        
        .tabs {
            overflow-x: scroll;
        }
        
        .lot-tabs {
            overflow-x: auto;
        }
    }

    /* Daily Report Lot Sections */
    .lot-section {
        margin-bottom: 20px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .lot-section-header {
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        color: white;
        padding: 12px 20px;
        font-size: 16px;
        font-weight: bold;
    }

    .lot-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        padding: 15px;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }

    .lot-summary-item {
        background: white;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #e5e7eb;
    }

    .lot-summary-item .label {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 5px;
        text-transform: uppercase;
        font-weight: 600;
    }

    .lot-summary-item .value {
        font-size: 20px;
        font-weight: bold;
        color: #1f2937;
    }

    .daily-phones-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
        padding: 15px;
    }

    .daily-phone-item {
        padding: 10px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        text-align: center;
        background: white;
        transition: all 0.3s;
    }

    .daily-phone-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .daily-phone-item.highlight {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        border-color: #10b981;
    }

    .daily-summary-total {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin-top: 20px;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* Performance Dashboard Styles */
    .performance-cards-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .performance-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        position: relative;
        overflow: hidden;
        transition: all 0.3s;
        border: 3px solid transparent;
    }

    .performance-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .performance-card.profit-high {
        border-color: #10b981;
        background: linear-gradient(135deg, #ffffff 0%, #d1fae5 100%);
    }

    .performance-card.profit-medium {
        border-color: #f59e0b;
        background: linear-gradient(135deg, #ffffff 0%, #fed7aa 100%);
    }

    .performance-card.profit-loss {
        border-color: #ef4444;
        background: linear-gradient(135deg, #ffffff 0%, #fee2e2 100%);
    }

    .traffic-light {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    .performance-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .performance-card-title {
        font-size: 18px;
        font-weight: bold;
        color: #1f2937;
    }

    .performance-bars {
        margin: 20px 0;
    }

    .performance-bar {
        margin-bottom: 15px;
    }

    .performance-bar-label {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
    }

    .performance-bar-track {
        height: 30px;
        background: #e5e7eb;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }

    .performance-bar-fill {
        height: 100%;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
        transition: width 1s ease-in-out;
        position: relative;
    }

    .performance-bar-fill.cost {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }

    .performance-bar-fill.revenue {
        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
    }

    .performance-bar-fill.profit {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
    }

    .performance-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #e5e7eb;
    }

    .metric-item {
        text-align: center;
    }

    .metric-label {
        font-size: 11px;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-value {
        font-size: 20px;
        font-weight: bold;
        margin-top: 5px;
    }

    .metric-value.positive {
        color: #10b981;
    }

    .metric-value.negative {
        color: #ef4444;
    }

    .metric-value.neutral {
        color: #6b7280;
    }

    /* Comparison Chart Legend */
    .chart-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

    .legend-color {
        width: 20px;
        height: 12px;
        border-radius: 3px;
    }

    /* Search Highlight */
    mark {
        background: #fef08a;
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: 600;
    }

    #historySearchInput {
        background: white;
        border: 2px solid #e5e7eb;
        padding: 10px 16px;
        border-radius: 10px;
        font-size: 14px;
    }

    #historySearchInput:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }

    #searchResultCount {
        font-weight: 600;
        transition: color 0.3s;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Print Styles */
    @media print {
        body {
            background: white;
            padding: 0;
        }
        .container {
            box-shadow: none;
            padding: 20px;
        }
        .tabs, .button-group, button {
            display: none !important;
        }
        .tab-content {
            display: none !important;
        }
        .tab-content.active {
            display: block !important;
        }
        #dailyReportContent {
            display: block !important;
        }
        .print-title {
            display: block !important;
            text-align: center;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #000;
            padding: 8px;
        }
    }

    /* === Enhanced Print Styles for Beautiful PDF === */
    @media print {
        @page {
            size: A4;
            margin: 15mm 10mm;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Sarabun', 'Noto Sans Thai', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #1a1a1a;
            background: white;
        }
        
        /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå */
        .header, .lot-selector, .tabs, .button-group, 
        .btn, .modal, .sync-status, .lot-actions,
        #bulkDeleteBar, .phone-item-checkbox,
        .remove-btn, button, .filter-section,
        .input-method-tabs, .form-grid {
            display: none !important;
        }
        
        /* PDF Header */
        /* PDF Header - Bold & Vibrant Colors */
        .pdf-header {
            display: block !important;
            text-align: center;
            padding: 35px 25px;
            margin-bottom: 35px;
            position: relative;
            background: linear-gradient(
                135deg,
                #6a11cb 0%,
                #2575fc 25%,
                #2107af 50%,
                #0a07d8 75%,
                #1259f1 100%
            );
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            color: white;
            border-radius: 20px;
            border: 3px solid #fff;
            box-shadow: 
                0 15px 40px rgba(106, 17, 203, 0.4),
                inset 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .pdf-header h1 {
            font-size: 36pt;
            font-weight: 900;
            margin: 0 0 20px 0;
            color: #ffffff;
            text-shadow: 
                4px 4px 8px rgba(0, 0, 0, 0.5),
                0 0 30px rgba(255, 255, 255, 0.5),
                0 0 50px rgba(255, 255, 255, 0.3);
            letter-spacing: 2px;
            position: relative;
            z-index: 1;
        }

        .pdf-header .subtitle {
            font-size: 18pt;
            font-weight: 700;
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.98),
                rgba(240, 240, 240, 0.95)
            );
            color: #1a202c;
            padding: 12px 30px;
            border-radius: 30px;
            display: inline-block;
            margin-top: 10px;
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.2),
                inset 0 2px 5px rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.8);
            position: relative;
            z-index: 1;
        }

        .pdf-header .subtitle span#pdfReportType {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
            text-transform: uppercase;
        }

        .pdf-header .subtitle span#pdfDate {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
        }

        .pdf-header .subtitle span#pdfLotName {
            background: linear-gradient(45deg, #43e97b, #38f9d7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
        }
        
        /* Summary Cards for Print */
        .summary-grid {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
            page-break-inside: avoid;
        }
        
        .summary-card {
            border: 2px solid #e5e7eb;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            background: linear-gradient(135deg, #0520b9 0%, #200dc4 100%);
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .summary-card h3 {
            font-size: 10pt;
            color: #ffffff;
            margin-bottom: 8px;
        }
        
        .summary-card .value {
            font-size: 18pt;
            font-weight: bold;
            color: #fdfdfd;
        }
        
        /* Beautiful Tables */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        thead {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        th {
            color: white;
            font-weight: bold;
            padding: 12px 10px;
            font-size: 10pt;
            text-align: left;
            border: none;
        }
        
        td {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 10pt;
            color: #374151;
        }
        
        tbody tr:nth-child(even) {
            background: #f9fafb;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        tbody tr:hover {
            background: #f3f4f6;
        }
        
        /* Phone List Grid for Print */
        .phone-list {
            display: grid !important;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin: 20px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            max-height: none !important;
        }
        
        .phone-item {
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            text-align: center;
            font-size: 9pt;
            background: white;
        }
        
        .phone-item.sold {
            background: #10b981;
            color: white;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        /* Footer */
        .pdf-footer {
            display: block !important;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 2px solid #e5e7eb;
            text-align: center;
            font-size: 9pt;
            color: #6b7280;
        }
        
        /* Page Break Control */
        .page-break {
            page-break-after: always;
        }

        /* Daily Report PDF Specific Styles */
        @media print {
            /* Force show daily report content */
            #dailyReportContent,
            #dailyPhonesList,
            #dailyReportTableBody,
            .daily-report-section {
                display: block !important;
                visibility: visible !important;
            }
            
            .daily-report-container {
                display: block !important;
            }
            
            .lot-section {
                page-break-inside: avoid;
                margin-bottom: 30px;
                border: 2px solid #7c3aed;
                border-radius: 10px;
                padding: 15px;
                background: #fafafa;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .lot-section-header {
                background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
                color: white;
                padding: 12px 15px;
                margin: -15px -15px 15px -15px;
                border-radius: 8px 8px 0 0;
                font-size: 14pt;
                font-weight: bold;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .lot-summary {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .lot-summary-item {
                background: white;
                padding: 10px;
                border-radius: 6px;
                border: 1px solid #e5e7eb;
                text-align: center;
            }
            
            .lot-summary-item .label {
                font-size: 9pt;
                color: #6b7280;
                margin-bottom: 5px;
            }
            
            .lot-summary-item .value {
                font-size: 14pt;
                font-weight: bold;
                color: #1f2937;
            }
            
            .daily-phones-grid {
                display: grid !important;
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
                margin: 15px 0;
                padding: 10px;
                background: white;
                border-radius: 6px;
            }
            
            .daily-phone-item {
                padding: 8px;
                border: 1px solid #cbd5e1;
                border-radius: 4px;
                text-align: center;
                font-size: 10pt;
                background: #f9fafb;
            }
            
            .daily-phone-item.highlight {
                background: #dcfce7 !important;
                border-color: #10b981;
                font-weight: bold;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .daily-summary-total {
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                padding: 15px;
                border-radius: 8px;
                margin-top: 20px;
                text-align: center;
                font-size: 14pt;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Show only daily report content when printing */
            body.printing-daily-report .container > *:not(#tab-dailyReport),
            body.printing-daily-report .tabs,
            body.printing-daily-report .header,
            body.printing-daily-report .lot-selector,
            body.printing-daily-report .section:not(.daily-report-printable) {
                display: none !important;
            }
            
            body.printing-daily-report #tab-dailyReport {
                display: block !important;
            }
            
            body.printing-daily-report #dailyReportContent {
                display: block !important;
            }
        }
        
        .no-break {
            page-break-inside: avoid;
        }
    }

    /* PDF-only elements (hidden on screen) */
    .pdf-header, .pdf-footer {
        display: none;
    }

    /* Print-only content */
    .print-only-content {
        display: none;
    }

    @media print {
        .print-only-content {
            display: block !important;
            padding: 20px;
        }
        
        body.printing-daily-report .print-only-content {
            display: block !important;
        }
        
        body.printing-daily-report > *:not(.pdf-header):not(.pdf-footer):not(.print-only-content) {
            display: none !important;
        }
    }

    @media screen {
        .print-only {
            display: none !important;
        }
    }

    /* Print-only elements */
    .print-only {
        display: none;
    }

    @media print {
        .print-only {
            display: block;
        }
    }
</style>
</head>
<body>

<!-- Enhanced PDF Header (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå) -->
<div class="pdf-header print-only">
    <h1>üì± ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</h1>
    <div class="subtitle">
        <span id="pdfReportType">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</span> | 
        <span id="pdfDate"></span> | 
        <span id="pdfLotName"></span>
    </div>
</div>

<!-- PDF Footer -->
<div class="pdf-footer print-only">
    <div>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: <span id="pdfTimestamp"></span></div>
    <div style="margin-top: 5px;">Phone Auction System v5.0 Ultimate Edition</div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast">
    <div class="toast-content">
        <div class="toast-icon" id="toastIcon">‚úì</div>
        <div id="toastMessage"></div>
    </div>
</div>

<!-- Edit Sale Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
            <button class="close" onclick="closeEditModal()">√ó</button>
        </div>
        <div class="form-group">
            <label>Lot</label>
            <select id="editLot">
                <!-- Will be populated -->
            </select>
        </div>
        <div class="form-group">
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="editDate">
        </div>
        <div class="form-group">
            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
            <input type="text" id="editPhoneNumber" placeholder="xxx-xxx-xxxx">
        </div>
        <div class="form-group">
            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" id="editPrice" placeholder="0">
        </div>
        <div class="form-group">
            <label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</label>
            <select id="editChannel">
                <option value="auction">‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•</option>
                <option value="direct">‡∏Ç‡∏≤‡∏¢‡∏ï‡∏£‡∏á</option>
                <option value="online">‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</option>
                <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
            </select>
        </div>
        <div class="form-group">
            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <textarea id="editNote" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
        </div>
        <div class="button-group" style="margin-top: 24px;">
            <button class="btn btn-success" onclick="saveEdit()">
                üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </button>
            <button class="btn btn-danger" onclick="closeEditModal()">
                ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
        </div>
    </div>
</div>

<!-- Edit Lot Modal -->
<div id="editLotModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Lot</h3>
            <button class="close" onclick="closeEditLotModal()">√ó</button>
        </div>
        <div class="form-group">
            <label>‡∏ä‡∏∑‡πà‡∏≠ Lot</label>
            <input type="text" id="editLotName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠ Lot">
        </div>
        <div class="form-group">
            <label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
            <textarea id="editLotDescription" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
        </div>
        <div class="form-group">
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
            <input type="number" id="editLotTotalNumbers" placeholder="0">
        </div>
        <div class="form-group">
            <label>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" id="editLotTotalCost" placeholder="0">
        </div>
        <div class="button-group" style="margin-top: 24px;">
            <button class="btn btn-success" onclick="saveEditLot()">
                üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </button>
            <button class="btn btn-warning" onclick="recalculateLotCost()">
                üîÑ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÉ‡∏´‡∏°‡πà
            </button>
            <button class="btn btn-danger" onclick="closeEditLotModal()">
                ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
        </div>
    </div>
</div>

<!-- Edit Phone Modal (NEW - ‡∏à‡∏≤‡∏Å v4.1) -->
<div id="editPhoneModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏≠‡∏£‡πå</h3>
            <button class="close" onclick="closeEditPhoneModal()">√ó</button>
        </div>
        <div class="form-group">
            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
            <input type="text" id="editPhoneModalNumber" readonly style="background: #f8fafc;">
        </div>
        <div class="form-group">
            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" id="editPhoneCost" placeholder="0">
        </div>
        <div class="form-group">
            <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
            <select id="editPhoneStatus">
                <option value="available">‡∏ß‡πà‡∏≤‡∏á</option>
                <option value="sold">‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</option>
                <option value="reserved">‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</option>
            </select>
        </div>
        <div class="form-group">
            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" id="editPhoneSalePrice" placeholder="0">
        </div>
        <div class="form-group">
            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <textarea id="editPhoneNote" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
        </div>
        <div class="button-group" style="margin-top: 24px;">
            <button class="btn btn-success" onclick="saveEditPhone()">
                üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </button>
            <button class="btn btn-danger" onclick="closeEditPhoneModal()">
                ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
        </div>
    </div>
</div>

<!-- Add Lot Modal -->
<div id="addLotModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Lot ‡πÉ‡∏´‡∏°‡πà</h3>
            <button class="close" onclick="closeAddLotModal()">√ó</button>
        </div>
        <div class="form-group">
            <label>‡∏ä‡∏∑‡πà‡∏≠ Lot</label>
            <input type="text" id="newLotName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Lot A, Lot ‡∏°.‡∏Ñ.67">
        </div>
        <div class="form-group">
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
            <input type="number" id="newLotNumbers" placeholder="0">
        </div>
        <div class="form-group">
            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" id="newLotCost" placeholder="0">
        </div>
        <div class="form-group">
            <label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
            <textarea id="newLotDescription" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
        </div>
        <div class="button-group" style="margin-top: 24px;">
            <button class="btn btn-primary" onclick="addNewLot()">
                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Lot
            </button>
            <button class="btn btn-danger" onclick="closeAddLotModal()">
                ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
        </div>
    </div>
</div>

<!-- Add Phone Modal (‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÅ‡∏ö‡∏ö Manual ‡∏à‡∏≤‡∏Å phone_auction_opus.html) -->
<div id="addPhoneModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà</h3>
            <button class="close" onclick="closeAddPhoneModal()">√ó</button>
        </div>
        <div class="form-group">
            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
            <input type="text" id="newPhoneNumber" placeholder="xxx-xxx-xxxx">
        </div>
        <div class="form-group">
            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" id="newPhoneCost" placeholder="0">
        </div>
        <div class="form-group">
            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <textarea id="newPhoneNote" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
        </div>
        <div class="button-group" style="margin-top: 24px;">
            <button class="btn btn-primary" onclick="addNewPhone()">
                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå
            </button>
            <button class="btn btn-danger" onclick="closeAddPhoneModal()">
                ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
        </div>
    </div>
</div>

<div class="container">
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div>
                <h1>üì± Phone Auction System v5.0</h1>
                <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;">
                    Ultimate Edition - ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏î‡∏µ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô
                </div>
            </div>
            <div class="sync-status" id="syncStatus">
                <div class="sync-indicator"></div>
                <span id="syncText">Checking...</span>
            </div>
        </div>
    </div>

    <!-- Lot Selector -->
    <div class="lot-selector">
        <div class="lot-selector-title">
            üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Lot:
        </div>
        <div class="lot-tabs" id="lotTabs">
            <!-- Will be populated dynamically -->
        </div>
        <div class="lot-actions">
            <button class="btn btn-primary btn-small" onclick="showAddLotModal()">
                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Lot
            </button>
            <button class="btn btn-info btn-small" onclick="toggleMultiSelect()">
                üìä ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢ Lot
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content">
        <!-- Dashboard Overview -->
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <div class="label">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</div>
                <div class="value" id="dashTotalCost">0</div>
            </div>
            <div class="dashboard-card">
                <div class="label">üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå</div>
                <div class="value" id="dashTotalNumbers">0</div>
            </div>
            <div class="dashboard-card">
                <div class="label">üìä ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏≤‡∏¢</div>
                <div class="value" id="dashTotalSales">0</div>
            </div>
            <div class="dashboard-card">
                <div class="label">‚úÖ ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
                <div class="value" id="dashSoldCount">0</div>
            </div>
            <div class="dashboard-card">
                <div class="label">üíπ ‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</div>
                <div class="value" id="dashProfit">0</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('setup')">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Lot</button>
            <button class="tab-button" onclick="switchTab('stock')">üì¶ Stock ‡πÄ‡∏ö‡∏≠‡∏£‡πå</button>
            <button class="tab-button" onclick="switchTab('daily')">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
            <button class="tab-button" onclick="switchTab('dailyReport')">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
            <button class="tab-button" onclick="switchTab('history')">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            <button class="tab-button" onclick="switchTab('analytics')">üìà ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
            <button class="tab-button" onclick="switchTab('profitRate')">üí∞ ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡∏•‡∏Å‡∏≥‡πÑ‡∏£</button>
            <button class="tab-btn" onclick="switchTab('performance')">üö¶ Performance Dashboard</button>
        </div>

        <!-- Tab: Setup -->
        <div id="tab-setup" class="tab-content active">
            <div class="section">
                <h3 class="section-title">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Lot <span id="currentLotName"></span></h3>
                <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ Lot -->
                <div id="lotDescriptionDisplay" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); padding: 12px; border-radius: 8px; margin: 10px 0; display: none;">
                    <strong>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</strong> <span id="lotDescriptionText" style="color: #64748b;"></span>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        <input type="number" id="initTotalNumbers" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="initTotalCost" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏≠‡∏£‡πå (.txt, .csv)</label>
                        <input type="file" id="numberFileInput" accept=".txt,.csv">
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveLotSettings()">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                    </button>
                    <button class="btn btn-success" onclick="showAddPhoneModal()">
                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå Manual
                    </button>
                    <button class="btn btn-warning" onclick="exportInventory()">
                        üìÑ Export ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏≠‡∏£‡πå
                    </button>
                    <button class="btn btn-danger" onclick="deleteLot()">
                        üóëÔ∏è ‡∏•‡∏ö Lot ‡∏ô‡∏µ‡πâ
                    </button>
                    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ -->
                    <button class="btn btn-warning" onclick="toggleBulkDelete()">
                        ‚òëÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </button>
                    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Tab Setup -->
                    <button class="btn btn-info" onclick="updateAllPhoneCosts()">
                        üí∞ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå
                    </button>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">üì± ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏ô Lot ‡∏ô‡∏µ‡πâ</h3>
                <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô phoneListContainer -->
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-warning btn-small" onclick="toggleBulkDelete()">
                        ‚òëÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </button>
                </div>

                <!-- Bulk Delete Bar (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô) -->
                <div id="bulkDeleteBar" style="display: none; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 12px 20px; border-radius: 12px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-weight: 600;">
                            ‚òëÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß <span id="selectedCount">0</span> ‡πÄ‡∏ö‡∏≠‡∏£‡πå
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-small" style="background: white; color: #dc2626;" onclick="selectAllPhones()">
                                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </button>
                            <button class="btn btn-small" style="background: white; color: #dc2626;" onclick="clearSelection()">
                                ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å  
                            </button>
                            <button class="btn btn-small" style="background: #7f1d1d;" onclick="deleteSelectedPhones()">
                                üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                            </button>
                        </div>
                    </div>
                </div>
                <div class="phone-list" id="phoneListContainer">
                    <p style="color: var(--gray); text-align: center; grid-column: 1/-1;">
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏≠‡∏£‡πå
                    </p>
                </div>
            </div>
        </div>

        <!-- Tab: Stock (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≤‡∏Å v4.1) -->
        <div id="tab-stock" class="tab-content">
            <div class="section">
                <h3 class="section-title">üì¶ Stock ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <!-- Search Section -->
                <div class="filter-section" style="margin-bottom: 15px;">
                    <div class="filter-label">
                        üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå:
                    </div>
                    <input type="text" 
                        id="historySearchInput" 
                        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." 
                        style="flex: 1; max-width: 300px;"
                        onkeyup="searchHistoryPhone(event)">
                    <button class="btn btn-primary btn-small" onclick="searchHistory()">
                        üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>
                    <button class="btn btn-warning btn-small" onclick="clearHistorySearch()">
                        ‚ùå ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>
                    <span id="searchResultCount" style="margin-left: 15px; color: #6b7280; font-size: 14px;"></span>
                </div>
                <!-- Filter Section (NEW ‡∏à‡∏≤‡∏Å v4.1) -->
                <div class="filter-section">
                    <div class="filter-label">
                        üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Lot:
                    </div>
                    <div class="lot-filter-chips" id="stockLotFilter">
                        <!-- Will be populated -->
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Lot</th>
                                <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
                                <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Daily Recording -->
        <div id="tab-daily" class="tab-content">
            <!-- Progress Bar -->
            <div class="progress-container" id="progressContainer" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
            </div>

            <!-- Input Method Selector -->
            <div class="section">
                <h3 class="section-title">üìù ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
                <div class="input-method-tabs">
                    <button class="method-btn active" onclick="switchInputMethod('single')">
                        üìù ‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå
                    </button>
                    <button class="method-btn" onclick="switchInputMethod('bulk')">
                        üìã ‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå
                    </button>
                    <button class="method-btn" onclick="switchInputMethod('file')">
                        üìÅ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
                    </button>
                </div>
            </div>

            <!-- Single Entry -->
            <div id="single-entry" class="section input-method-content active">
                <h3 class="section-title">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Lot</label>
                        <select id="saleLot">
                            <!-- Will be populated -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="saleDate">
                    </div>
                    <div class="form-group">
                        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                        <input type="text" id="phoneNumber" placeholder="xxx-xxx-xxxx">
                    </div>
                    <div class="form-group">
                        <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="salePrice" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</label>
                        <select id="saleChannel">
                            <option value="auction">‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•</option>
                            <option value="direct">‡∏Ç‡∏≤‡∏¢‡∏ï‡∏£‡∏á</option>
                            <option value="online">‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</option>
                            <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea id="saleNote" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                    </div>
                </div>
                <button class="btn btn-success" onclick="addSale()">
                    ‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
                </button>
            </div>

            <!-- Bulk Entry -->
            <div id="bulk-entry" class="section input-method-content">
                <h3 class="section-title">üìã ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Lot</label>
                        <select id="bulkLot">
                            <!-- Will be populated -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="bulkDate">
                    </div>
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡πÄ‡∏ö‡∏≠‡∏£‡πå,‡∏£‡∏≤‡∏Ñ‡∏≤,‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á,‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏)</label>
                        <textarea id="bulkSalesData" rows="10" placeholder="‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö 1: ‡πÄ‡∏ö‡∏≠‡∏£‡πå,‡∏£‡∏≤‡∏Ñ‡∏≤,‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á,‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
091-234-5678,1500,auction,‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡∏µ
089-876-5432,1200,direct,‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô

‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö 2: ‡πÄ‡∏ö‡∏≠‡∏£‡πå[tab]‡∏£‡∏≤‡∏Ñ‡∏≤[tab]‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
0919632235	600	‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ VIP
0919592299	900

‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö 3: ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÉ‡∏™‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà DD/MM/YYYY)
15/08/2025
0919632235	600
0919592299	900
16/08/2025
0893692245	1100"></textarea>
                    </div>
                    <div class="form-group" style="grid-column: 1/-1;">
                        <small style="color: var(--gray);">
                            üìå ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 3 ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: comma, tab-separated, ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô<br>
                            üìå ‡πÉ‡∏™‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà DD/MM/YYYY ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô
                        </small>
                    </div>
                </div>
                <button class="btn btn-success" onclick="processBulkSales()">
                    üìã ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>

            <!-- File Upload -->
            <div id="file-entry" class="section input-method-content">
                <h3 class="section-title">üìÅ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Lot</label>
                        <select id="fileLot">
                            <!-- Will be populated -->
                        </select>
                    </div>
                    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏±‡∏á select channel -->
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label>‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå (.txt, .csv)</label>
                        <div class="button-group">
                            <button class="btn btn-warning" onclick="document.getElementById('bulkFileInput').click()">
                                üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
                            </button>
                            <input type="file" id="bulkFileInput" accept=".txt,.csv" style="display: none;" onchange="processBulkFile(this)">
                        </div>
                        <small style="color: var(--gray);">
                            üìå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡πÄ‡∏ö‡∏≠‡∏£‡πå[tab]‡∏£‡∏≤‡∏Ñ‡∏≤[tab]‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå,‡∏£‡∏≤‡∏Ñ‡∏≤,‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏<br>
                            üìå ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÇ‡∏î‡∏¢‡πÉ‡∏™‡πà DD/MM/YYYY ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ö‡πà‡∏á
                        </small>
                    </div>
                </div>
                <button class="btn btn-success" onclick="processSalesFile()">
                    üìÅ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå
                </button>
            </div>

            <div class="section">
                <h3 class="section-title">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Lot</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                                <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                            </tr>
                        </thead>
                        <tbody id="recentSalesTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Daily Report -->
        <div id="tab-dailyReport" class="tab-content">
            <!-- Date Selector -->
            <div class="section">
                <h3 class="section-title">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                        <input type="date" id="reportDate" onchange="updateDailyReport()">
                    </div>
                    <div class="form-group">
                        <label>‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</label>
                        <select id="dateSelector" onchange="selectReportDate()">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà --</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Daily Report Content -->
            <div id="dailyReportContent" style="display: none;">
                <!-- Daily Summary Card -->
                <div class="dashboard-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-bottom: 20px;">
                    <h3 style="color: white; margin-bottom: 20px;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 14px; opacity: 0.9; color: white;">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
                            <div style="font-size: 36px; font-weight: bold; color: white;" id="dailyTotal">0</div>
                            <div style="font-size: 12px; color: white;">‡∏ö‡∏≤‡∏ó</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 14px; opacity: 0.9; color: white;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå</div>
                            <div style="font-size: 36px; font-weight: bold; color: white;" id="dailyCount">0</div>
                            <div style="font-size: 12px; color: white;">‡πÄ‡∏ö‡∏≠‡∏£‡πå</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 14px; opacity: 0.9; color: white;">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                            <div style="font-size: 36px; font-weight: bold; color: white;" id="dailyAverage">0</div>
                            <div style="font-size: 12px; color: white;">‡∏ö‡∏≤‡∏ó/‡πÄ‡∏ö‡∏≠‡∏£‡πå</div>
                        </div>
                    </div>
                </div>

                <!-- Daily Sales Table -->
                <div class="section">
                    <h3 class="section-title">üì± ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                    <div class="button-group" style="margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="printDailyReport()">
                            üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF
                        </button>
                        <button class="btn btn-success" onclick="exportDailyReportExcel()">
                            üìä Export Excel
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th>Lot</th>
                                    <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                                    <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                                    <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                </tr>
                            </thead>
                            <tbody id="dailyReportTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- All Days Summary -->
            <div class="section">
                <h3 class="section-title">üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
                                <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
                                <th>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                            </tr>
                        </thead>
                        <tbody id="allDaysSummaryBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: History (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≤‡∏Å v4.1) -->
        <div id="tab-history" class="tab-content">
            <div class="section">
                <h3 class="section-title">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                
                <!-- Filter Section (NEW ‡∏à‡∏≤‡∏Å v4.1) -->
                 <!-- Search Section -->
                <div class="filter-section" style="margin-bottom: 15px;">
                    <div class="filter-label">
                        üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå:
                    </div>
                    <input type="text" 
                        id="historySearchInput" 
                        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." 
                        style="flex: 1; max-width: 300px;"
                        onkeyup="searchHistoryPhone(event)">
                    <button class="btn btn-primary btn-small" onclick="searchHistory()">
                        üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>
                    <button class="btn btn-warning btn-small" onclick="clearHistorySearch()">
                        ‚ùå ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>
                    <span id="searchResultCount" style="margin-left: 15px; color: #6b7280; font-size: 14px;"></span>
                </div>
                <div class="filter-section">
                    <div class="filter-label">
                        üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Lot:
                    </div>
                    <div class="lot-filter-chips" id="historyLotFilter">
                        <!-- Will be populated -->
                    </div>
                </div>

                <div class="button-group" style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="exportToExcel()">
                        üìä Export Excel
                    </button>
                    <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤ -->
                    <button class="btn btn-primary" onclick="backupData()">
                        üíæ Backup ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">
                        üìÇ Import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button class="btn btn-danger" onclick="clearAllData()">
                        üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                    <button class="btn btn-info" onclick="showAdvancedReports()">
                        üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á
                    </button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                <th>Lot</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                                <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Analytics -->
        <div id="tab-analytics" class="tab-content">
            <div class="chart-container">
                <canvas id="salesChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="channelChart"></canvas>
            </div>
        </div>

        <!-- Tab: Performance Dashboard -->
        <div id="tab-performance" class="tab-content">
            <div class="section">
                <h3 class="section-title">üö¶ Performance Dashboard - ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</h3>
                
                <!-- Traffic Light Cards Container -->
                <div id="performanceCards" class="performance-cards-container">
                    <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                </div>
                
                <!-- Comparison Bar Chart -->
                <div class="section" style="margin-top: 30px;">
                    <h3 class="section-title">üìä ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ó‡∏∏‡∏Å Lot</h3>
                    <div class="chart-container" style="height: 400px; position: relative;">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
                
                <!-- Summary Table -->
                <div class="section" style="margin-top: 30px;">
                    <h3 class="section-title">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</h3>
                    <div class="table-container">
                        <table id="performanceSummaryTable">
                            <thead>
                                <tr>
                                    <th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                                    <th>Lot</th>
                                    <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th>
                                    <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th>
                                    <th>‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</th>
                                    <th>ROI %</th>
                                    <th>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                </tr>
                            </thead>
                            <tbody id="performanceTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Reports (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≤‡∏Å v4.1 - ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡∏•‡∏Å‡∏≥‡πÑ‡∏£) -->
        <div id="tab-reports" class="tab-content">
            <div class="section">
                <h3 class="section-title">üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡∏•‡∏Å‡∏≥‡πÑ‡∏£</h3>
                <div class="summary-grid">
                    <div class="summary-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                        <h3>üìä Lot ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <div class="value" id="totalLots">0</div>
                        <div class="subtitle">Lots</div>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                        <h3>üíº ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°</h3>
                        <div class="value" id="totalValue">0</div>
                        <div class="subtitle">‡∏ö‡∏≤‡∏ó</div>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <h3>üìà ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡∏•‡∏Å‡∏≥‡πÑ‡∏£</h3>
                        <div class="value" id="profitMargin">0%</div>
                        <div class="subtitle">(‡∏Å‡∏≥‡πÑ‡∏£ / ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô) √ó 100</div>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                        <h3>üìà ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
                        <div class="value" id="saleRate">0%</div>
                        <div class="subtitle">‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                </div>

                <div style="margin-top: 24px;">
                    <h4 style="margin-bottom: 16px;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ï‡πà‡∏•‡∏∞ Lot</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Lot</th>
                                    <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
                                    <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th>
                                    <th>‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</th>
                                    <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th>
                                    <th>‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</th>
                                    <th>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡∏•‡∏Å‡∏≥‡πÑ‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="lotSummaryTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyABovozdQm1teK9WZcHh4faEFF30XO778c",
        authDomain: "phone-auction.firebaseapp.com",
        databaseURL: "https://phone-auction-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "phone-auction",
        storageBucket: "phone-auction.firebasestorage.app",
        messagingSenderId: "572790293555",
        appId: "1:572790293555:web:e4a20df2cdd7d72fedcf46"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // Application State
    let appData = {
        lots: {},
        lastUpdate: null,
        version: '5.0'
    };
    
    let currentLot = null;
    let selectedLots = [];
    let multiSelectMode = false;
    let editingIndex = -1;
    let editingLot = null;
    let editingPhoneLot = null;
    let editingPhoneIndex = -1;
    let isOnline = false;
    let syncListener = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        initFirebase();
        setToday();
        
        // Check connection status
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
            isOnline = snap.val() === true;
            updateSyncStatus();
        });
    });

    function initFirebase() {
        syncListener = database.ref('phoneAuction').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                appData = data;
                if (!currentLot && Object.keys(appData.lots).length > 0) {
                    currentLot = Object.keys(appData.lots)[0];
                }
                updateAll();
            } else {
                // Initialize with default lot
                createDefaultLot();
            }
        });
    }

    function createDefaultLot() {
        const lotId = generateLotId();
        appData.lots[lotId] = {
            id: lotId,
            name: 'Lot A',
            createdAt: new Date().toISOString(),
            settings: {
                totalNumbers: 0,
                totalCost: 0,
                numbersList: []
            },
            sales: []
        };
        currentLot = lotId;
        saveToFirebase();
    }

    function generateLotId() {
        return 'lot_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function saveToFirebase() {
        appData.lastUpdate = new Date().toISOString();
        database.ref('phoneAuction').set(appData)
            .then(() => {
                console.log('Data saved successfully');
            })
            .catch((error) => {
                console.error('Error saving data:', error);
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
            });
    }

    function updateSyncStatus() {
        const statusEl = document.getElementById('syncStatus');
        const textEl = document.getElementById('syncText');
        
        if (isOnline) {
            statusEl.classList.add('online');
            statusEl.classList.remove('offline');
            textEl.textContent = 'Online';
        } else {
            statusEl.classList.remove('online');
            statusEl.classList.add('offline');
            textEl.textContent = 'Offline';
        }
    }

    // UI Updates
    function updateAll() {
        updateLotTabs();
        updateDashboard();
        updateCurrentLotDisplay();
        updateTables();
        updateCharts();
        updatePerformanceDashboard();
        updateLotFilters();
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ô function updateAll()
        updateDateSelector();
        updateAllDaysSummary();
    }

    // Daily Report Functions
    function updateDateSelector() {
        const selector = document.getElementById('dateSelector');
        const allSales = [];
        
        Object.keys(appData.lots).forEach(lotId => {
            if (appData.lots[lotId].sales) {
                allSales.push(...appData.lots[lotId].sales);
            }
        });
        
        const dates = [...new Set(allSales.map(s => s.date))].sort().reverse();
        
        selector.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà --</option>';
        dates.forEach(date => {
            const daySales = getSalesByDate(date);
            const option = document.createElement('option');
            option.value = date;
            option.textContent = formatDate(date) + ` (${daySales.length} ‡πÄ‡∏ö‡∏≠‡∏£‡πå)`;
            selector.appendChild(option);
        });
    }

    function selectReportDate() {
        const selector = document.getElementById('dateSelector');
        const dateInput = document.getElementById('reportDate');
        if (selector.value) {
            dateInput.value = selector.value;
            updateDailyReport();
        }
    }

    function getSalesByDate(date) {
        const allSales = [];
        Object.keys(appData.lots).forEach(lotId => {
            if (appData.lots[lotId].sales) {
                const lotSales = appData.lots[lotId].sales.filter(s => s.date === date);
                lotSales.forEach(sale => {
                    sale.lotId = lotId;
                    sale.lotName = appData.lots[lotId].name;
                });
                allSales.push(...lotSales);
            }
        });
        return allSales;
    }

    function updateDailyReport() {
        const selectedDate = document.getElementById('reportDate').value;
        if (!selectedDate) {
            document.getElementById('dailyReportContent').style.display = 'none';
            return;
        }
        
        const dailySales = getSalesByDate(selectedDate);
        
        if (dailySales.length === 0) {
            document.getElementById('dailyReportContent').style.display = 'none';
            showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'warning');
            return;
        }
        
        document.getElementById('dailyReportContent').style.display = 'block';
        
        // Group sales by lot
        const salesByLot = {};
        let totalRevenue = 0;
        
        dailySales.forEach(sale => {
            if (!salesByLot[sale.lotId]) {
                salesByLot[sale.lotId] = {
                    lotName: sale.lotName,
                    sales: [],
                    total: 0,
                    count: 0
                };
            }
            salesByLot[sale.lotId].sales.push(sale);
            salesByLot[sale.lotId].total += sale.price;
            salesByLot[sale.lotId].count += 1;
            totalRevenue += sale.price;
        });
        
        // Update summary
        const avgPrice = totalRevenue / dailySales.length;
        
        document.getElementById('dailyTotal').textContent = formatNumber(totalRevenue);
        document.getElementById('dailyCount').textContent = dailySales.length;
        document.getElementById('dailyAverage').textContent = formatNumber(avgPrice);
        
        // Update phones list grouped by lot
        const phonesList = document.getElementById('dailyPhonesList');
        if (phonesList) {
            phonesList.innerHTML = '';
            
            // Create sections for each lot
            Object.entries(salesByLot).forEach(([lotId, lotData]) => {
                const lotSection = document.createElement('div');
                lotSection.className = 'lot-section';
                lotSection.innerHTML = `
                    <div class="lot-section-header">
                        üì¶ ${lotData.lotName} (${lotData.count} ‡πÄ‡∏ö‡∏≠‡∏£‡πå)
                    </div>
                    <div class="lot-summary">
                        <div class="lot-summary-item">
                            <div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div>
                            <div class="value">${lotData.count}</div>
                        </div>
                        <div class="lot-summary-item">
                            <div class="label">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</div>
                            <div class="value">${formatNumber(lotData.total)}</div>
                        </div>
                        <div class="lot-summary-item">
                            <div class="label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                            <div class="value">${formatNumber(lotData.total / lotData.count)}</div>
                        </div>
                        <div class="lot-summary-item">
                            <div class="label">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</div>
                            <div class="value">${((lotData.total / totalRevenue) * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                    <div class="daily-phones-grid">
                        ${lotData.sales.map(sale => `
                            <div class="daily-phone-item ${sale.price >= 1000 ? 'highlight' : ''}">
                                <div style="font-weight: bold;">${sale.phoneNumber || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                                <div style="color: #059669; font-size: 9pt;">‡∏ø${formatNumber(sale.price)}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                phonesList.appendChild(lotSection);
            });
            
            // Add total summary
            const totalSummary = document.createElement('div');
            totalSummary.className = 'daily-summary-total';
            totalSummary.innerHTML = `
                <div style="font-size: 16pt; font-weight: bold;">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div style="font-size: 24pt; margin: 10px 0;">‡∏ø${formatNumber(totalRevenue)}</div>
                <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${dailySales.length} ‡πÄ‡∏ö‡∏≠‡∏£‡πå | ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏ø${formatNumber(avgPrice)}/‡πÄ‡∏ö‡∏≠‡∏£‡πå</div>
            `;
            phonesList.appendChild(totalSummary);
        }
        
        // Update table (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Lot)
        const tbody = document.getElementById('dailyReportTableBody');
        tbody.innerHTML = '';
        
        let rowIndex = 1;
        Object.entries(salesByLot).forEach(([lotId, lotData]) => {
            // Add lot header row
            const headerRow = tbody.insertRow();
            headerRow.style.backgroundColor = '#f3f4f6';
            headerRow.innerHTML = `
                <td colspan="6" style="font-weight: bold; background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; padding: 10px;">
                    üì¶ ${lotData.lotName} - ‡∏£‡∏ß‡∏° ${lotData.count} ‡πÄ‡∏ö‡∏≠‡∏£‡πå | ‡∏ø${formatNumber(lotData.total)}
                </td>
            `;
            
            // Add sales rows for this lot
            lotData.sales.forEach(sale => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${rowIndex++}</td>
                    <td>${sale.lotName}</td>
                    <td>${sale.phoneNumber || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå'}</td>
                    <td class="text-right">${formatNumber(sale.price)}</td>
                    <td>${getChannelText(sale.channel)}</td>
                    <td>${sale.note || '-'}</td>
                `;
            });
            
            // Add subtotal row
            const subtotalRow = tbody.insertRow();
            subtotalRow.style.backgroundColor = '#f9fafb';
            subtotalRow.innerHTML = `
                <td colspan="3" style="text-align: right; font-weight: bold;">‡∏£‡∏ß‡∏° ${lotData.lotName}:</td>
                <td style="font-weight: bold; text-align: right; color: #059669;">‡∏ø${formatNumber(lotData.total)}</td>
                <td colspan="2"></td>
            `;
        });
        
        // Add grand total row
        const totalRow = tbody.insertRow();
        totalRow.style.backgroundColor = '#10b981';
        totalRow.style.color = 'white';
        totalRow.innerHTML = `
            <td colspan="3" style="text-align: right; font-weight: bold; font-size: 14pt;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</td>
            <td style="font-weight: bold; text-align: right; font-size: 14pt;">‡∏ø${formatNumber(totalRevenue)}</td>
            <td colspan="2" style="text-align: center;">${dailySales.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
        `;
    }

    function updateAllDaysSummary() {
        const allSales = [];
        Object.keys(appData.lots).forEach(lotId => {
            if (appData.lots[lotId].sales) {
                allSales.push(...appData.lots[lotId].sales);
            }
        });
        
        // Group by date
        const salesByDate = {};
        allSales.forEach(sale => {
            if (!salesByDate[sale.date]) {
                salesByDate[sale.date] = [];
            }
            salesByDate[sale.date].push(sale);
        });
        
        const tbody = document.getElementById('allDaysSummaryBody');
        tbody.innerHTML = '';
        
        const dates = Object.keys(salesByDate).sort().reverse();
        
        if (dates.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</td></tr>';
            return;
        }
        
        dates.forEach(date => {
            const daySales = salesByDate[date];
            const totalRevenue = daySales.reduce((sum, sale) => sum + sale.price, 0);
            const avgPrice = totalRevenue / daySales.length;
            
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${formatDate(date)}</td>
                <td class="text-center">${daySales.length}</td>
                <td class="text-right">${formatNumber(totalRevenue)}</td>
                <td class="text-right">${formatNumber(avgPrice)}</td>
                <td class="text-center">
                    <button class="btn btn-info" style="padding: 6px 12px; font-size: 12px;" 
                            onclick="viewDayReport('${date}')">
                        üëÅÔ∏è ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    </button>
                </td>
            `;
        });
    }

    function viewDayReport(date) {
        document.getElementById('reportDate').value = date;
        document.getElementById('dateSelector').value = date;
        updateDailyReport();
        switchTab('dailyReport');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function printDailyReport() {
        printDailyReportEnhanced();
    }

    function exportDailyReportExcel() {
        const selectedDate = document.getElementById('reportDate').value;
        if (!selectedDate) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô', 'warning');
            return;
        }
        
        const dailySales = getSalesByDate(selectedDate);
        const totalRevenue = dailySales.reduce((sum, sale) => sum + sale.price, 0);
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        
        // Summary sheet
        const summaryData = [
            [`‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDate(selectedDate)}`],
            [''],
            ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢', dailySales.length],
            ['‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°', totalRevenue],
            ['‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢', totalRevenue / dailySales.length],
            [''],
            ['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢'],
            ['‡∏•‡∏≥‡∏î‡∏±‡∏ö', 'Lot', '‡πÄ‡∏ö‡∏≠‡∏£‡πå', '‡∏£‡∏≤‡∏Ñ‡∏≤', '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']
        ];
        
        dailySales.forEach((sale, index) => {
            summaryData.push([
                index + 1,
                sale.lotName || '-',
                sale.phoneNumber,
                sale.price,
                getChannelText(sale.channel),
                sale.note || '-'
            ]);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, ws, '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô');
        
        // Export file
        XLSX.writeFile(wb, `daily_report_${selectedDate}.xlsx`);
        
        showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('th-TH', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }

    function updateLotTabs() {
        const container = document.getElementById('lotTabs');
        container.innerHTML = '';
        
        Object.keys(appData.lots).forEach(lotId => {
            const lot = appData.lots[lotId];
            const tab = document.createElement('div');
            tab.className = 'lot-tab';
            if (currentLot === lotId) {
                tab.classList.add('active');
            }
            
            const salesCount = lot.sales ? lot.sales.length : 0;
            tab.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                    <span onclick="selectLot('${lotId}')">
                        ${lot.name}
                        ${salesCount > 0 ? `<span class="badge">${salesCount}</span>` : ''}
                    </span>
                    <button class="lot-menu-button" onclick="showLotMenu('${lotId}', event)">‚ãÆ</button>
                </div>
                <div id="lotMenu_${lotId}" class="lot-actions-menu">
                    <div class="lot-action-item" onclick="editLot('${lotId}')">
                        ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Lot
                    </div>
                    <div class="lot-action-item" onclick="duplicateLot('${lotId}')">
                        üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Lot
                    </div>
                    <div class="lot-action-item" onclick="exportLot('${lotId}')">
                        üíæ Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </div>
                    <div class="lot-action-item danger" onclick="deleteLot('${lotId}')">
                        üóëÔ∏è ‡∏•‡∏ö Lot ‡∏ô‡∏µ‡πâ
                    </div>
                </div>
            `;
            
            container.appendChild(tab);
        });
    }

    // === Lot Management Functions ===
    let editingLotId = null;

    function showLotMenu(lotId, event) {
        event.stopPropagation();
        
        // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        document.querySelectorAll('.lot-actions-menu').forEach(menu => {
            menu.classList.remove('show');
        });
        
        // Toggle ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å
        const menu = document.getElementById(`lotMenu_${lotId}`);
        menu.classList.toggle('show');
        
        // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô
        document.addEventListener('click', function closeMenu(e) {
            if (!menu.contains(e.target)) {
                menu.classList.remove('show');
                document.removeEventListener('click', closeMenu);
            }
        });
    }

    function editLot(lotId) {
        editingLotId = lotId;
        const lot = appData.lots[lotId];
        
        document.getElementById('editLotName').value = lot.name;
        document.getElementById('editLotDescription').value = lot.description || '';
        document.getElementById('editLotTotalNumbers').value = lot.settings.totalNumbers || '';
        document.getElementById('editLotTotalCost').value = lot.settings.totalCost || '';
        
        document.getElementById('editLotModal').style.display = 'block';
        document.getElementById(`lotMenu_${lotId}`).classList.remove('show');
    }

    function saveEditLot() {
        if (!editingLotId) return;
        
        const lot = appData.lots[editingLotId];
        lot.name = document.getElementById('editLotName').value.trim();
        lot.description = document.getElementById('editLotDescription').value.trim();
        lot.settings.totalNumbers = parseInt(document.getElementById('editLotTotalNumbers').value) || 0;
        lot.settings.totalCost = parseFloat(document.getElementById('editLotTotalCost').value) || 0;
        
        saveToFirebase();
        updateAll();
        closeEditLotModal();
        showToast(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Lot "${lot.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
    }

    function closeEditLotModal() {
        document.getElementById('editLotModal').style.display = 'none';
        editingLotId = null;
    }

    function duplicateLot(lotId) {
        const originalLot = appData.lots[lotId];
        const newLotId = 'lot_' + Date.now();
        
        appData.lots[newLotId] = {
            ...JSON.parse(JSON.stringify(originalLot)), // Deep copy
            id: newLotId,
            name: originalLot.name + ' (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å)',
            createdAt: new Date().toISOString(),
            sales: [] // Reset sales
        };
        
        saveToFirebase();
        updateAll();
        showToast(`‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Lot "${originalLot.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        document.getElementById(`lotMenu_${lotId}`).classList.remove('show');
    }

    function deleteLot(lotId) {
        const lot = appData.lots[lotId];
        
        if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö Lot "${lot.name}" ?\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`)) {
            if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ‡∏•‡∏ö Lot "${lot.name}" ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?`)) {
                delete appData.lots[lotId];
                
                if (currentLot === lotId) {
                    currentLot = Object.keys(appData.lots)[0] || null;
                }
                
                saveToFirebase();
                updateAll();
                showToast(`‡∏•‡∏ö Lot "${lot.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
            }
        }
        
        document.getElementById(`lotMenu_${lotId}`).classList.remove('show');
}

    function updateLotFilters() {
        // Update Stock Filter
        const stockFilter = document.getElementById('stockLotFilter');
        if (stockFilter) {
            stockFilter.innerHTML = '<div class="lot-chip selected" onclick="selectFilterLot(\'all\', \'stock\')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>';
            Object.keys(appData.lots).forEach(lotId => {
                const lot = appData.lots[lotId];
                stockFilter.innerHTML += `<div class="lot-chip" onclick="selectFilterLot('${lotId}', 'stock')">${lot.name}</div>`;
            });
        }
        
        // Update History Filter
        const historyFilter = document.getElementById('historyLotFilter');
        if (historyFilter) {
            historyFilter.innerHTML = '<div class="lot-chip selected" onclick="selectFilterLot(\'all\', \'history\')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>';
            Object.keys(appData.lots).forEach(lotId => {
                const lot = appData.lots[lotId];
                historyFilter.innerHTML += `<div class="lot-chip" onclick="selectFilterLot('${lotId}', 'history')">${lot.name}</div>`;
            });
        }
    }

    function selectFilterLot(lotId, filterType) {
        const filterContainer = filterType === 'stock' ? 
            document.getElementById('stockLotFilter') : 
            document.getElementById('historyLotFilter');
        
        const chips = filterContainer.querySelectorAll('.lot-chip');
        chips.forEach(chip => chip.classList.remove('selected'));
        
        if (lotId === 'all') {
            chips[0].classList.add('selected');
        } else {
            const index = Object.keys(appData.lots).indexOf(lotId) + 1;
            if (chips[index]) {
                chips[index].classList.add('selected');
            }
        }
        
        if (filterType === 'stock') {
            updateStockTable(lotId);
        } else {
            updateHistoryTable(lotId);
        }
    }

    function selectLot(lotId) {
        if (multiSelectMode) {
            const index = selectedLots.indexOf(lotId);
            if (index > -1) {
                selectedLots.splice(index, 1);
            } else {
                selectedLots.push(lotId);
            }
        } else {
            currentLot = lotId;
            selectedLots = [];
        }
        updateAll();
    }

    function toggleMultiSelect() {
        multiSelectMode = !multiSelectMode;
        if (!multiSelectMode) {
            selectedLots = [];
        }
        updateAll();
    }

    function updateDashboard() {
        let totalCost = 0;
        let totalNumbers = 0;
        let totalSales = 0;
        let soldCount = 0;
        
        const lotsToProcess = multiSelectMode && selectedLots.length > 0 ? 
            selectedLots : (currentLot ? [currentLot] : []);
        
        lotsToProcess.forEach(lotId => {
            const lot = appData.lots[lotId];
            if (lot) {
                totalCost += lot.settings.totalCost || 0;
                totalNumbers += lot.settings.totalNumbers || 0;
                
                if (lot.sales) {
                    soldCount += lot.sales.length;
                    totalSales += lot.sales.reduce((sum, sale) => sum + sale.price, 0);
                }
            }
        });
        
        const profit = totalSales - totalCost;
        
        document.getElementById('dashTotalCost').textContent = totalCost.toLocaleString();
        document.getElementById('dashTotalNumbers').textContent = totalNumbers.toLocaleString();
        document.getElementById('dashTotalSales').textContent = totalSales.toLocaleString();
        document.getElementById('dashSoldCount').textContent = soldCount.toLocaleString();
        document.getElementById('dashProfit').textContent = profit.toLocaleString();
        document.getElementById('dashProfit').style.color = profit >= 0 ? 'var(--success)' : 'var(--danger)';
    }

    function updateCurrentLotDisplay() {
        if (!currentLot || !appData.lots[currentLot]) return;
        
        const lot = appData.lots[currentLot];
        document.getElementById('currentLotName').textContent = lot.name;
        
        // ‡πÅ‡∏™‡∏î‡∏á description ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        const descDisplay = document.getElementById('lotDescriptionDisplay');
        const descText = document.getElementById('lotDescriptionText');
        if (descDisplay && descText) {
            if (lot.description) {
                descText.textContent = lot.description;
                descDisplay.style.display = 'block';
            } else {  
                descDisplay.style.display = 'none';
            }
        }
        
        document.getElementById('initTotalNumbers').value = lot.settings.totalNumbers || '';
        document.getElementById('initTotalCost').value = lot.settings.totalCost || '';
        
        updatePhoneList();
        updateSaleLotOptions();
    }

    function updatePhoneList() {
        if (!currentLot || !appData.lots[currentLot]) return;
        
        const container = document.getElementById('phoneListContainer');
        const numbers = appData.lots[currentLot].settings.numbersList;
        
        if (!numbers || numbers.length === 0) {
            container.innerHTML = '<p style="color: var(--gray); text-align: center; grid-column: 1/-1;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏≠‡∏£‡πå</p>';
            return;
        }
        
        container.innerHTML = '';
        numbers.forEach((phone, index) => {
            const div = document.createElement('div');
            div.className = 'phone-item';
            if (phone.status === 'sold') {
                div.classList.add('sold');
            }
            div.innerHTML = `
                ${phone.number}
                ${phone.status === 'sold' ? `<div class="price">‡∏ø${phone.salePrice}</div>` : ''}
                <button class="remove-btn" onclick="removePhone(${index})">√ó</button>
            `;
            container.appendChild(div);
        });
    }

    function updateSaleLotOptions() {
        const saleLot = document.getElementById('saleLot');
        const editLot = document.getElementById('editLot');
        const bulkLot = document.getElementById('bulkLot');
        const fileLot = document.getElementById('fileLot');
        
        saleLot.innerHTML = '';
        editLot.innerHTML = '';
        bulkLot.innerHTML = '';
        fileLot.innerHTML = '';
        
        Object.keys(appData.lots).forEach(lotId => {
            const lot = appData.lots[lotId];
            const option1 = new Option(lot.name, lotId);
            const option2 = new Option(lot.name, lotId);
            const option3 = new Option(lot.name, lotId);
            const option4 = new Option(lot.name, lotId);
            
            if (lotId === currentLot) {
                option1.selected = true;
                option3.selected = true;
                option4.selected = true;
            }
            
            saleLot.add(option1);
            editLot.add(option2);
            bulkLot.add(option3);
            fileLot.add(option4);
        });
    }

    function updateTables() {
        updateStockTable('all');
        updateHistoryTable('all');
        updateRecentSales();
        updateReportTables();
    }

    function updateStockTable(filterLotId = 'all') {
        const tbody = document.getElementById('stockTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        const lotsToShow = filterLotId === 'all' ? 
            Object.keys(appData.lots) : [filterLotId];
        
        lotsToShow.forEach(lotId => {
            const lot = appData.lots[lotId];
            if (!lot || !lot.settings.numbersList) return;
            
            lot.settings.numbersList.forEach((phone, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${lot.name}</td>
                    <td>${phone.number}</td>
                    <td>${(phone.cost || 0).toLocaleString()}</td>
                    <td>
                        <span style="
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 12px;
                            font-weight: 600;
                            background: ${phone.status === 'sold' ? 'var(--success)' : 
                                        phone.status === 'reserved' ? 'var(--warning)' : 
                                        'var(--gray)'};
                            color: white;
                        ">
                            ${phone.status === 'sold' ? '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : 
                              phone.status === 'reserved' ? '‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ß‡πà‡∏≤‡∏á'}
                        </span>
                    </td>
                    <td>${phone.salePrice ? phone.salePrice.toLocaleString() : '-'}</td>
                    <td>${phone.note || '-'}</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="editPhone('${lotId}', ${index})">
                            ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                    </td>
                `;
            });
        });
    }

    let historySearchTerm = '';

    function updateHistoryTable(filterLotId = 'all') {
        const tbody = document.getElementById('historyTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        let allSales = [];
        const lotsToShow = filterLotId === 'all' ? 
            Object.keys(appData.lots) : [filterLotId];
        
        lotsToShow.forEach(lotId => {
            const lot = appData.lots[lotId];
            if (lot && lot.sales) {
                lot.sales.forEach((sale, index) => {
                    allSales.push({
                        ...sale,
                        lotId: lotId,
                        lotName: lot.name,
                        originalIndex: index
                    });
                });
            }
        });
        
        // Filter by search term if exists
        if (historySearchTerm) {
            const searchLower = historySearchTerm.toLowerCase();
            allSales = allSales.filter(sale => {
                const phoneNumber = (sale.phoneNumber || '').toLowerCase();
                return phoneNumber.includes(searchLower);
            });
            
            // Update search result count
            const countEl = document.getElementById('searchResultCount');
            if (countEl) {
                countEl.textContent = `‡∏û‡∏ö ${allSales.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                countEl.style.color = allSales.length > 0 ? '#10b981' : '#ef4444';
            }
        } else {
            const countEl = document.getElementById('searchResultCount');
            if (countEl) {
                countEl.textContent = '';
            }
        }
        
        // Sort by date
        allSales.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        if (allSales.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 30px; color: #9ca3af;">
                ${historySearchTerm ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢'}
            </td></tr>`;
            return;
        }
        
        allSales.forEach((sale, index) => {
            const row = tbody.insertRow();
            
            // Highlight search term
            let phoneDisplay = sale.phoneNumber || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå';
            if (historySearchTerm && sale.phoneNumber) {
                const regex = new RegExp(`(${historySearchTerm})`, 'gi');
                phoneDisplay = phoneDisplay.replace(regex, '<mark style="background: #fef08a; padding: 2px; border-radius: 3px;">$1</mark>');
            }
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${sale.lotName}</td>
                <td>${formatDate(sale.date)}</td>
                <td>${phoneDisplay}</td>
                <td>${sale.price.toLocaleString()}</td>
                <td>${getChannelText(sale.channel)}</td>
                <td>${sale.note || '-'}</td>
                <td>
                    <button class="btn btn-primary btn-small" 
                            onclick="editSale('${sale.lotId}', ${sale.originalIndex})">
                        ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                    <button class="btn btn-danger btn-small" 
                            onclick="deleteSale('${sale.lotId}', ${sale.originalIndex})">
                        üóëÔ∏è ‡∏•‡∏ö
                    </button>
                </td>
            `;
        });
    }

    function searchHistory() {
        const input = document.getElementById('historySearchInput');
        if (!input) return;
        
        historySearchTerm = input.value.trim();
        updateHistoryTable('all'); // Search in all lots
        
        if (historySearchTerm) {
            showToast(`üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${historySearchTerm}"`, 'info');
        }
    }

    function searchHistoryPhone(event) {
        if (event.key === 'Enter') {
            searchHistory();
        }
    }

    function clearHistorySearch() {
        const input = document.getElementById('historySearchInput');
        if (input) {
            input.value = '';
        }
        historySearchTerm = '';
        updateHistoryTable('all');
        
        const countEl = document.getElementById('searchResultCount');
        if (countEl) {
            countEl.textContent = '';
        }
        
        showToast('‚ùå ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
    }

    function updateRecentSales() {
        const tbody = document.getElementById('recentSalesTable');
        tbody.innerHTML = '';
        
        let recentSales = [];
        Object.keys(appData.lots).forEach(lotId => {
            const lot = appData.lots[lotId];
            if (lot.sales) {
                lot.sales.forEach(sale => {
                    recentSales.push({
                        ...sale,
                        lotName: lot.name
                    });
                });
            }
        });
        
        recentSales.sort((a, b) => new Date(b.date) - new Date(a.date));
        recentSales = recentSales.slice(0, 10);
        
        recentSales.forEach(sale => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${sale.lotName}</td>
                <td>${formatDate(sale.date)}</td>
                <td>${sale.phoneNumber}</td>
                <td>${sale.price.toLocaleString()}</td>
                <td>${getChannelText(sale.channel)}</td>
                <td>${sale.note || '-'}</td>
            `;
        });
    }

    function updateReportTables() {
        // Update summary cards
        const lotCount = Object.keys(appData.lots).length;
        let totalValue = 0;
        let totalCost = 0;
        let totalSales = 0;
        let totalNumbers = 0;
        let soldCount = 0;
        
        Object.values(appData.lots).forEach(lot => {
            totalCost += lot.settings.totalCost || 0;
            totalNumbers += lot.settings.totalNumbers || 0;
            if (lot.sales) {
                totalSales += lot.sales.reduce((sum, sale) => sum + sale.price, 0);
                soldCount += lot.sales.length;
            }
        });
        
        totalValue = totalSales;
        const profit = totalSales - totalCost;
        const profitMargin = totalCost > 0 ? ((profit / totalCost) * 100).toFixed(2) : 0;
        const saleRate = totalNumbers > 0 ? ((soldCount / totalNumbers) * 100).toFixed(2) : 0;
        
        document.getElementById('totalLots').textContent = lotCount;
        document.getElementById('totalValue').textContent = totalValue.toLocaleString();
        document.getElementById('profitMargin').textContent = profitMargin + '%';
        document.getElementById('saleRate').textContent = saleRate + '%';
        
        // Update lot summary table
        const tbody = document.getElementById('lotSummaryTable');
        tbody.innerHTML = '';
        
        Object.values(appData.lots).forEach(lot => {
            const lotSales = lot.sales ? lot.sales.reduce((sum, sale) => sum + sale.price, 0) : 0;
            const lotProfit = lotSales - lot.settings.totalCost;
            const lotProfitMargin = lot.settings.totalCost > 0 ? 
                ((lotProfit / lot.settings.totalCost) * 100).toFixed(2) : 0;
            const lotSold = lot.sales ? lot.sales.length : 0;
            
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${lot.name}</td>
                <td>${lot.settings.totalNumbers}</td>
                <td>${lot.settings.totalCost.toLocaleString()}</td>
                <td>${lotSold}</td>
                <td>${lotSales.toLocaleString()}</td>
                <td style="color: ${lotProfit >= 0 ? 'var(--success)' : 'var(--danger)'}">
                    ${lotProfit.toLocaleString()}
                </td>
                <td>${lotProfitMargin}%</td>
            `;
        });
    }

    function updateCharts() {
        updateSalesChart();
        updateChannelChart();
    }

    function updateSalesChart() {
        const ctx = document.getElementById('salesChart');
        if (!ctx) return;
        
        const dates = {};
        Object.values(appData.lots).forEach(lot => {
            if (lot.sales) {
                lot.sales.forEach(sale => {
                    if (!dates[sale.date]) dates[sale.date] = 0;
                    dates[sale.date] += sale.price;
                });
            }
        });
        
        const sortedDates = Object.keys(dates).sort();
        const last30Days = sortedDates.slice(-30);
        
        if (window.salesChartInstance) {
            window.salesChartInstance.destroy();
        }
        
        window.salesChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: last30Days,
                datasets: [{
                    label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô',
                    data: last30Days.map(date => dates[date]),
                    borderColor: 'rgb(124, 58, 237)',
                    backgroundColor: 'rgba(124, 58, 237, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'üìà ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)'
                    }
                }
            }
        });
    }

    function updateChannelChart() {
        const ctx = document.getElementById('channelChart');
        if (!ctx) return;
        
        const channels = {
            'auction': 0,
            'direct': 0,
            'online': 0,
            'other': 0
        };
        
        Object.values(appData.lots).forEach(lot => {
            if (lot.sales) {
                lot.sales.forEach(sale => {
                    channels[sale.channel] = (channels[sale.channel] || 0) + 1;
                });
            }
        });
        
        if (window.channelChartInstance) {
            window.channelChartInstance.destroy();
        }
        
        window.channelChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•', '‡∏Ç‡∏≤‡∏¢‡∏ï‡∏£‡∏á', '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'],
                datasets: [{
                    data: Object.values(channels),
                    backgroundColor: [
                        'rgba(124, 58, 237, 0.8)',
                        'rgba(236, 72, 153, 0.8)',
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(245, 158, 11, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'üìä ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢'
                    }
                }
            }
        });
    }

    // Tab Management
    function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove active class from all buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        // Add active class to clicked button
        event.target.classList.add('active');
        
        // Update charts if analytics tab
        if (tabName === 'analytics') {
            setTimeout(() => {
                updateCharts();
            }, 100);
        }

        if (tabName === 'performance') {
            setTimeout(() => {
                updatePerformanceDashboard();
            }, 100);
        }
    }

    // Lot Management
    function showAddLotModal() {
        document.getElementById('addLotModal').style.display = 'block';
    }

    function closeAddLotModal() {
        document.getElementById('addLotModal').style.display = 'none';
        document.getElementById('newLotName').value = '';
        document.getElementById('newLotNumbers').value = '';
        document.getElementById('newLotCost').value = '';
        document.getElementById('newLotDescription').value = '';
    }

    function addNewLot() {
        const name = document.getElementById('newLotName').value.trim();
        const numbers = parseInt(document.getElementById('newLotNumbers').value) || 0;
        const cost = parseFloat(document.getElementById('newLotCost').value) || 0;
        const description = document.getElementById('newLotDescription').value.trim();
        
        if (!name) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ Lot', 'error');
            return;
        }
        
        const lotId = generateLotId();
        appData.lots[lotId] = {
            id: lotId,
            name: name,
            description: description,
            createdAt: new Date().toISOString(),
            settings: {
                totalNumbers: numbers,
                totalCost: cost,
                numbersList: []
            },
            sales: []
        };
        
        currentLot = lotId;
        saveToFirebase();
        updateAll();
        closeAddLotModal();
        showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
    }

    function saveLotSettings() {
        if (!currentLot || !appData.lots[currentLot]) return;
        
        const totalNumbers = parseInt(document.getElementById('initTotalNumbers').value) || 0;
        const totalCost = parseInt(document.getElementById('initTotalCost').value) || 0;
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå
        const costPerNumber = totalNumbers > 0 ? Math.round(totalCost / totalNumbers) : 0;
        
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        appData.lots[currentLot].settings.totalNumbers = totalNumbers;
        appData.lots[currentLot].settings.totalCost = totalCost;
        appData.lots[currentLot].settings.costPerNumber = costPerNumber; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
        
        // ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå
        if (appData.lots[currentLot].settings.numbersList) {
            appData.lots[currentLot].settings.numbersList.forEach(phone => {
                if (!phone.cost || phone.cost === 0) { // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô
                    phone.cost = costPerNumber;
                }
            });
        }
        
        saveToFirebase();
        updateAll();
        showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${costPerNumber.toLocaleString()} ‡∏ö‡∏≤‡∏ó)`, 'success');
    }

    function deleteLot() {
        if (!currentLot) return;
        
        const lotCount = Object.keys(appData.lots).length;
        if (lotCount <= 1) {
            showToast('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Lot ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 Lot', 'error');
            return;
        }
        
        const lotName = appData.lots[currentLot].name;
        if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${lotName} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£`)) {
            delete appData.lots[currentLot];
            
            // Switch to first available lot
            const remaining = Object.keys(appData.lots);
            if (remaining.length > 0) {
                currentLot = remaining[0];
            }
            
            saveToFirebase();
            updateAll();
            showToast(`‡∏•‡∏ö ${lotName} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        }
    }

    function updateAllPhoneCosts() {
        if (!currentLot || !appData.lots[currentLot]) return;
        
        const totalNumbers = appData.lots[currentLot].settings.totalNumbers || 0;
        const totalCost = appData.lots[currentLot].settings.totalCost || 0;
        
        if (totalNumbers === 0 || totalCost === 0) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô', 'error');
            return;
        }
        
        if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô ${Math.round(totalCost/totalNumbers).toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏ö‡∏≠‡∏£‡πå?`)) {
            const costPerNumber = Math.round(totalCost / totalNumbers);
            
            if (appData.lots[currentLot].settings.numbersList) {
                appData.lots[currentLot].settings.numbersList.forEach(phone => {
                    phone.cost = costPerNumber;
                });
            }
            
            appData.lots[currentLot].settings.costPerNumber = costPerNumber;
            
            saveToFirebase();
            updateAll();
            showToast(`‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô ${costPerNumber.toLocaleString()} ‡∏ö‡∏≤‡∏ó`, 'success');
        }
    }

    // Phone Management
    function showAddPhoneModal() {
        document.getElementById('addPhoneModal').style.display = 'block';
    }

    function closeAddPhoneModal() {
        document.getElementById('addPhoneModal').style.display = 'none';
        document.getElementById('newPhoneNumber').value = '';
        document.getElementById('newPhoneCost').value = '';
        document.getElementById('newPhoneNote').value = '';
    }

    // ‚úÖ ‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

    function addNewPhone() {
        if (!currentLot) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Lot ‡∏Å‡πà‡∏≠‡∏ô', 'error');
            return;
        }
        
        const number = document.getElementById('newPhoneNumber').value.trim();
        let cost = parseFloat(document.getElementById('newPhoneCost').value);
        const note = document.getElementById('newPhoneNote').value.trim();
        
        if (!number) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', 'error');
            return;
        }
        
        // ‡πÉ‡∏ä‡πâ isNaN() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á Lot ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å
        if (isNaN(cost) || cost === 0) {
            cost = appData.lots[currentLot].settings.costPerNumber || 0;
        }
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
        const newPhone = {
            number: number,
            cost: cost,
            status: 'available',
            salePrice: 0,
            saleDate: null, // ‡πÄ‡∏û‡∏¥‡πà‡∏° property ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
            note: note
        };
        
        if (!appData.lots[currentLot].settings.numbersList) {
            appData.lots[currentLot].settings.numbersList = [];
        }
        
        appData.lots[currentLot].settings.numbersList.push(newPhone);
        
        // ‡πÉ‡∏ä‡πâ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤ (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î)
        saveToFirebase();
        updateAll();
        closeAddPhoneModal();
        showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    function removePhone(index) {
        if (!currentLot || !appData.lots[currentLot]) return;
        
        if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            appData.lots[currentLot].settings.numbersList.splice(index, 1);
            saveToFirebase();
            updateAll();
            showToast('‡∏•‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }
    }
    
    // === Bulk Delete Functions ===
    let bulkDeleteMode = false;
    let selectedPhones = new Set();

    function toggleBulkDelete() {
        bulkDeleteMode = !bulkDeleteMode;
        selectedPhones.clear();
        
        const bulkBar = document.getElementById('bulkDeleteBar');
        if (bulkBar) {
            bulkBar.style.display = bulkDeleteMode ? 'block' : 'none';
        }
        
        updatePhoneList(); // Refresh list with/without checkboxes
    }

    // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà function updatePhoneList ‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    function updatePhoneList() {
        if (!currentLot || !appData.lots[currentLot]) return;
        
        const container = document.getElementById('phoneListContainer');
        const numbers = appData.lots[currentLot].settings.numbersList;
        
        if (!numbers || numbers.length === 0) {
            container.innerHTML = '<p style="color: var(--gray); text-align: center; grid-column: 1/-1;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏≠‡∏£‡πå</p>';
            return;
        }
        
        container.innerHTML = '';
        numbers.forEach((phone, index) => {
            const div = document.createElement('div');
            div.className = 'phone-item';
            div.style.position = 'relative';
            
            if (phone.status === 'sold') {
                div.classList.add('sold');
            }
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° checkbox ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î bulk delete
            let checkboxHtml = '';
            if (bulkDeleteMode) {
                const isChecked = selectedPhones.has(index);
                checkboxHtml = `<input type="checkbox" 
                    ${isChecked ? 'checked' : ''} 
                    style="position: absolute; top: 8px; left: 8px; width: 18px; height: 18px; cursor: pointer;"
                    onclick="togglePhoneSelection(${index}, event)">`;
                div.style.paddingLeft = '35px';
                
                if (isChecked) {
                    div.style.background = '#fee2e2';
                    div.style.borderColor = '#dc2626';
                }
            }
            
            div.innerHTML = `
                ${checkboxHtml}
                ${phone.number}
                ${phone.status === 'sold' ? 
                    `<div class="price">‡∏Ç‡∏≤‡∏¢: ${phone.salePrice?.toLocaleString() || 0} ‡∏ö‡∏≤‡∏ó</div>` : 
                    `<div class="price">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ${phone.cost?.toLocaleString() || 0} ‡∏ö‡∏≤‡∏ó</div>`
                }
                ${!bulkDeleteMode ? `<button class="remove-btn" onclick="removePhone(${index})">√ó</button>` : ''}
            `;
            
            container.appendChild(div);
        });
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        if (bulkDeleteMode) {
            document.getElementById('selectedCount').textContent = selectedPhones.size;
        }
    }

    function togglePhoneSelection(index, event) {
        event.stopPropagation();
        
        if (selectedPhones.has(index)) {
            selectedPhones.delete(index);
        } else {
            selectedPhones.add(index);
        }
        
        updatePhoneList();
    }

    function selectAllPhones() {
        if (!currentLot || !appData.lots[currentLot]) return;
        
        const numbers = appData.lots[currentLot].settings.numbersList;
        for (let i = 0; i < numbers.length; i++) {
            selectedPhones.add(i);
        }
        
        updatePhoneList();
    }

    function clearSelection() {
        selectedPhones.clear();
        updatePhoneList();
    }

    function deleteSelectedPhones() {
        if (selectedPhones.size === 0) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'warning');
            return;
        }
        
        if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${selectedPhones.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) {
            return;
        }
        
        // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ index ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô
        const indices = Array.from(selectedPhones).sort((a, b) => b - a);
        
        indices.forEach(index => {
            appData.lots[currentLot].settings.numbersList.splice(index, 1);
        });
        
        selectedPhones.clear();
        bulkDeleteMode = false;
        document.getElementById('bulkDeleteBar').style.display = 'none';
        
        saveToFirebase();
        updateAll();
        showToast(`‡∏•‡∏ö ${indices.length} ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
    }

    function editPhone(lotId, index) {
        if (!appData.lots[lotId] || !appData.lots[lotId].settings.numbersList[index]) {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏≠‡∏£‡πå', 'error');
            return;
        }
        
        const phone = appData.lots[lotId].settings.numbersList[index];
        editingPhoneLot = lotId;
        editingPhoneIndex = index;
        
        document.getElementById('editPhoneModalNumber').value = phone.number;
        document.getElementById('editPhoneCost').value = phone.cost || 0;
        document.getElementById('editPhoneStatus').value = phone.status || 'available';
        document.getElementById('editPhoneSalePrice').value = phone.salePrice || '';
        document.getElementById('editPhoneNote').value = phone.note || '';
        
        document.getElementById('editPhoneModal').style.display = 'block';
    }

    function saveEditPhone() {
        if (editingPhoneIndex === -1 || !editingPhoneLot) return;
        
        const cost = parseFloat(document.getElementById('editPhoneCost').value) || 0;
        const status = document.getElementById('editPhoneStatus').value;
        const salePrice = parseFloat(document.getElementById('editPhoneSalePrice').value) || 0;
        const note = document.getElementById('editPhoneNote').value;
        
        appData.lots[editingPhoneLot].settings.numbersList[editingPhoneIndex].cost = cost;
        appData.lots[editingPhoneLot].settings.numbersList[editingPhoneIndex].status = status;
        appData.lots[editingPhoneLot].settings.numbersList[editingPhoneIndex].salePrice = salePrice;
        appData.lots[editingPhoneLot].settings.numbersList[editingPhoneIndex].note = note;
        
        saveToFirebase();
        updateAll();
        closeEditPhoneModal();
        showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    function closeEditPhoneModal() {
        document.getElementById('editPhoneModal').style.display = 'none';
        editingPhoneLot = null;
        editingPhoneIndex = -1;
    }

    // Sales Management
    function switchInputMethod(method) {
        // Hide all input methods
        document.querySelectorAll('.input-method-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Remove active from all buttons
        document.querySelectorAll('.method-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected method
        document.getElementById(`${method}-entry`).classList.add('active');
        
        // Add active to clicked button
        event.target.classList.add('active');
        
        // Update lot selects
        updateSaleLotOptions();
    }

    function showProgress(text, percent) {
        const container = document.getElementById('progressContainer');
        const fill = document.getElementById('progressFill');
        const textEl = document.getElementById('progressText');
        
        container.style.display = 'block';
        fill.style.width = percent + '%';
        fill.textContent = percent + '%';
        textEl.textContent = text;
    }

    function hideProgress() {
        setTimeout(() => {
            document.getElementById('progressContainer').style.display = 'none';
        }, 1000);
    }

    function processBulkSales() {
        const lotId = document.getElementById('bulkLot').value;
        const date = document.getElementById('bulkDate').value;
        const data = document.getElementById('bulkSalesData').value.trim();
        
        if (!lotId || !date || !data) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
            return;
        }
        
        // ‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
        const lines = data.split('\n').filter(line => line.trim());
        let currentDate = date;
        let processed = 0;
        let errors = [];
        
        showProgress('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', 0);
        
        // Initialize sales array if not exists
        if (!appData.lots[lotId].sales) {
            appData.lots[lotId].sales = [];
        }
        
        lines.forEach((line, index) => {
            line = line.trim();
            if (!line) return;
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY)
            const datePattern = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
            const dateMatch = line.match(datePattern);
            
            if (dateMatch) {
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å DD/MM/YYYY ‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD
                const day = dateMatch[1].padStart(2, '0');
                const month = dateMatch[2].padStart(2, '0');
                const year = dateMatch[3];
                currentDate = `${year}-${month}-${day}`;
                return;
            }
            
            // ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ tab ‡∏´‡∏£‡∏∑‡∏≠ comma
            let parts;
            if (line.includes('\t')) {
                parts = line.split('\t');
            } else if (line.includes(',')) {
                parts = line.split(',');
            } else {
                parts = line.split(/\s+/);
            }
            
            if (parts.length >= 2) {
                const phoneNumber = parts[0].trim().replace(/-/g, '');
                const price = parseFloat(parts[1].trim());
                const channel = parts[2] ? parts[2].trim() : 'auction';
                const note = parts[3] ? parts[3].trim() : '';
                
                if (phoneNumber && price > 0) {
                    // Add sale
                    appData.lots[lotId].sales.push({
                        date: currentDate,
                        phoneNumber: phoneNumber,
                        price: price,
                        channel: channel,
                        note: note || `Bulk Add - ${new Date().toLocaleDateString('th-TH')}`,
                        timestamp: new Date().toISOString()
                    });
                    
                    // Update phone status if exists
                    if (appData.lots[lotId].settings.numbersList) {
                        const phoneIndex = appData.lots[lotId].settings.numbersList.findIndex(
                            p => p.number === phoneNumber
                        );
                        if (phoneIndex !== -1) {
                            appData.lots[lotId].settings.numbersList[phoneIndex].status = 'sold';
                            appData.lots[lotId].settings.numbersList[phoneIndex].salePrice = price;
                            appData.lots[lotId].settings.numbersList[phoneIndex].saleDate = currentDate;
                            appData.lots[lotId].settings.numbersList[phoneIndex].note = note;
                        }
                    }
                    
                    processed++;
                } else {
                    errors.push(index + 1);
                }
            } else {
                errors.push(index + 1);
            }
            
            // Update progress
            const progress = Math.round(((index + 1) / lines.length) * 100);
            showProgress(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•... (${index + 1}/${lines.length})`, progress);
        });
        
        // Sort sales
        appData.lots[lotId].sales.sort((a, b) => {
            const dateCompare = new Date(b.date) - new Date(a.date);
            if (dateCompare !== 0) return dateCompare;
            return new Date(b.timestamp) - new Date(a.timestamp);
        });
        
        saveToFirebase();
        updateAll();
        
        hideProgress();
        
        // Clear form
        document.getElementById('bulkSalesData').value = '';
        
        if (errors.length > 0) {
            showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${processed} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${errors.length} ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î`, 'warning');
        } else {
            showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${processed} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        }
    }

    function processBulkFile(input) {
        const file = input.files[0];
        if (!file) return;
        
        const lotId = document.getElementById('fileLot').value;
        const date = document.getElementById('fileDate').value;
        
        if (!lotId || !date) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Lot ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'error');
            input.value = '';
            return;
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á Progress Bar
        showProgress('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...', 0);
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            const lines = content.split('\n').filter(line => line.trim());
            
            let currentDate = date;
            const channel = document.getElementById('fileChannel').value;
            let processed = 0;
            let errors = [];
            let processedDates = new Set();
            
            if (!appData.lots[lotId].sales) {
                appData.lots[lotId].sales = [];
            }
            
            const totalLines = lines.length;
            
            lines.forEach((line, index) => {
                line = line.trim();
                if (!line) return;
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Progress Bar
                const progress = Math.round(((index + 1) / totalLines) * 100);
                showProgress(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•... (${index + 1}/${totalLines})`, progress);
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY)
                const datePattern = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
                const dateMatch = line.match(datePattern);
                
                if (dateMatch) {
                    const day = dateMatch[1].padStart(2, '0');
                    const month = dateMatch[2].padStart(2, '0');
                    const year = dateMatch[3];
                    currentDate = `${year}-${month}-${day}`;
                    processedDates.add(`${day}/${month}/${year}`);
                    return;
                }
                
                // ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ tab ‡∏´‡∏£‡∏∑‡∏≠ comma
                let parts;
                if (line.includes('\t')) {
                    parts = line.split('\t');
                } else if (line.includes(',')) {
                    parts = line.split(',');
                } else {
                    parts = line.split(/\s+/);
                }
                
                if (parts.length >= 2) {
                    const phoneNumber = parts[0].trim().replace(/-/g, '');
                    const price = parseFloat(parts[1].trim());
                    const noteFromFile = parts[2] ? parts[2].trim() : '';
                    
                    if (phoneNumber && price >= 0) {
                        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
                        appData.lots[lotId].sales.push({
                            date: currentDate,
                            phoneNumber: phoneNumber,
                            price: price,
                            channel: channel,
                            note: noteFromFile || `File Import - ${new Date().toLocaleDateString('th-TH')}`,
                            timestamp: new Date().toISOString()
                        });
                        
                        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå
                        if (appData.lots[lotId].settings.numbersList) {
                            const phoneIndex = appData.lots[lotId].settings.numbersList.findIndex(
                                p => p.number === phoneNumber
                            );
                            if (phoneIndex !== -1) {
                                appData.lots[lotId].settings.numbersList[phoneIndex].status = 'sold';
                                appData.lots[lotId].settings.numbersList[phoneIndex].salePrice = price;
                                appData.lots[lotId].settings.numbersList[phoneIndex].saleDate = currentDate;
                                appData.lots[lotId].settings.numbersList[phoneIndex].note = noteFromFile;
                            }
                        }
                        
                        processed++;
                    } else {
                        errors.push(index + 1);
                    }
                } else {
                    errors.push(index + 1);
                }
            });
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
            appData.lots[lotId].sales.sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            
            saveToFirebase();
            updateAll();
            
            hideProgress();
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            let message = `‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${processed} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
            if (processedDates.size > 1) {
                message += ` ‡∏à‡∏≤‡∏Å ${processedDates.size} ‡∏ß‡∏±‡∏ô`;
            }
            if (errors.length > 0) {
                message += ` (‡∏°‡∏µ ${errors.length} ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏î‡πâ)`;
            }
            showToast(message, 'success');
            
            // Clear file input
            input.value = '';
        };
        
        reader.readAsText(file, 'UTF-8');
    }

    function processSalesFile() {
        const lotId = document.getElementById('fileLot').value;
        const date = document.getElementById('fileDate').value;
        const fileInput = document.getElementById('salesFileInput');
        const file = fileInput.files[0];
        
        if (!lotId || !date || !file) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error');
            return;
        }
        
        showProgress('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...', 0);
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            const lines = content.split('\n');
            let processed = 0;
            let errors = [];
            
            lines.forEach((line, index) => {
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const phoneNumber = parts[0].trim();
                    const price = parseFloat(parts[1].trim());
                    const channel = parts[2] ? parts[2].trim() : 'auction';
                    const note = parts[3] ? parts[3].trim() : '';
                    
                    if (phoneNumber && price > 0) {
                        // Initialize sales array if not exists
                        if (!appData.lots[lotId].sales) {
                            appData.lots[lotId].sales = [];
                        }
                        
                        // Add sale
                        appData.lots[lotId].sales.push({
                            date: date,
                            phoneNumber: phoneNumber,
                            price: price,
                            channel: channel,
                            note: note,
                            timestamp: new Date().toISOString()
                        });
                        
                        // Update phone status if exists
                        if (appData.lots[lotId].settings.numbersList) {
                            const phoneIndex = appData.lots[lotId].settings.numbersList.findIndex(
                                p => p.number === phoneNumber
                            );
                            if (phoneIndex !== -1) {
                                appData.lots[lotId].settings.numbersList[phoneIndex].status = 'sold';
                                appData.lots[lotId].settings.numbersList[phoneIndex].salePrice = price;
                                appData.lots[lotId].settings.numbersList[phoneIndex].saleDate = date;
                            }
                        }
                        
                        processed++;
                    } else if (line.trim()) {
                        errors.push(`‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ${index + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                    }
                }
                
                showProgress(`‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${index + 1}/${lines.length}`, 
                    Math.round(((index + 1) / lines.length) * 100));
            });
            
            // Sort sales
            appData.lots[lotId].sales.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            saveToFirebase();
            updateAll();
            
            hideProgress();
            
            if (errors.length > 0) {
                showToast(`‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î ${processed} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${errors.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'warning');
            } else {
                showToast(`‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î ${processed} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
            }
            
            // Clear file input
            fileInput.value = '';
        };
        
        reader.readAsText(file);
    }

    function addSale() {
        const lotId = document.getElementById('saleLot').value;
        const date = document.getElementById('saleDate').value;
        const phoneNumber = document.getElementById('phoneNumber').value;
        const price = parseFloat(document.getElementById('salePrice').value);
        const channel = document.getElementById('saleChannel').value;
        const note = document.getElementById('saleNote').value;
        const sale = {
            lotId: lotId,  // ‡πÉ‡∏ä‡πâ lotId ‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
            phoneNumber: phoneNumber,  // ‡πÉ‡∏ä‡πâ phoneNumber ‡∏à‡∏≤‡∏Å input
            price: price,
            date: date,
            channel: channel,
            note: note,
            timestamp: new Date().toISOString()
        };
        
        if (!lotId || !date || !phoneNumber || !price || price <= 0) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
            return;
        }
        
        if (!appData.lots[lotId]) {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö Lot ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'error');
            return;
        }
        
        // Initialize sales array if not exists
        if (!appData.lots[lotId].sales) {
            appData.lots[lotId].sales = [];
        }
        
        // Add sale
        appData.lots[lotId].sales.push({
            date: date,
            phoneNumber: phoneNumber,
            price: price,
            channel: channel,
            note: note || '',
            timestamp: new Date().toISOString()
        });
        
        // Update phone status if exists
        if (appData.lots[lotId].settings.numbersList) {
            const phoneIndex = appData.lots[lotId].settings.numbersList.findIndex(
                p => p.number === phoneNumber
            );
            if (phoneIndex !== -1) {
                appData.lots[lotId].settings.numbersList[phoneIndex].status = 'sold';
                appData.lots[lotId].settings.numbersList[phoneIndex].salePrice = price;
                appData.lots[lotId].settings.numbersList[phoneIndex].saleDate = date;
                appData.lots[lotId].settings.numbersList[phoneIndex].note = note;
            }
        }
        
        // Sort sales
        appData.lots[lotId].sales.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // Clear form
        document.getElementById('phoneNumber').value = '';
        document.getElementById('salePrice').value = '';
        document.getElementById('saleNote').value = '';
        
        saveToFirebase();
        updateAll();
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    function editSale(lotId, index) {
        if (!appData.lots[lotId] || !appData.lots[lotId].sales[index]) {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢', 'error');
            return;
        }
        
        const sale = appData.lots[lotId].sales[index];
        editingLot = lotId;
        editingIndex = index;
        
        // Fill modal
        document.getElementById('editLot').value = lotId;
        document.getElementById('editDate').value = sale.date;
        document.getElementById('editPhoneNumber').value = sale.phoneNumber;
        document.getElementById('editPrice').value = sale.price;
        document.getElementById('editChannel').value = sale.channel;
        document.getElementById('editNote').value = sale.note || '';
        
        // Show modal
        document.getElementById('editModal').style.display = 'block';
    }

    function saveEdit() {
        if (editingIndex === -1 || !editingLot) return;
        
        const newLotId = document.getElementById('editLot').value;
        const date = document.getElementById('editDate').value;
        const phoneNumber = document.getElementById('editPhoneNumber').value;
        const price = parseFloat(document.getElementById('editPrice').value);
        const channel = document.getElementById('editChannel').value;
        const note = document.getElementById('editNote').value;
        
        if (!date || !phoneNumber || !price || price <= 0) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
            return;
        }
        
        // If lot changed, move sale
        if (newLotId !== editingLot) {
            // Remove from old lot
            const sale = appData.lots[editingLot].sales.splice(editingIndex, 1)[0];
            
            // Add to new lot
            if (!appData.lots[newLotId].sales) {
                appData.lots[newLotId].sales = [];
            }
            appData.lots[newLotId].sales.push({
                date: date,
                phoneNumber: phoneNumber,
                price: price,
                channel: channel,
                note: note || '',
                timestamp: sale.timestamp
            });
        } else {
            // Update existing sale
            appData.lots[editingLot].sales[editingIndex] = {
                date: date,
                phoneNumber: phoneNumber,
                price: price,
                channel: channel,
                note: note || '',
                timestamp: appData.lots[editingLot].sales[editingIndex].timestamp
            };
        }
        
        saveToFirebase();
        updateAll();
        closeEditModal();
        showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        editingIndex = -1;
        editingLot = null;
    }

    function deleteSale(lotId, index) {
        if (!appData.lots[lotId] || !appData.lots[lotId].sales[index]) {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢', 'error');
            return;
        }
        
        if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            const sale = appData.lots[lotId].sales[index];
            
            // Update phone status if exists
            if (appData.lots[lotId].settings.numbersList) {
                const phoneIndex = appData.lots[lotId].settings.numbersList.findIndex(
                    p => p.number === sale.phoneNumber
                );
                if (phoneIndex !== -1) {
                    appData.lots[lotId].settings.numbersList[phoneIndex].status = 'available';
                    delete appData.lots[lotId].settings.numbersList[phoneIndex].salePrice;
                    delete appData.lots[lotId].settings.numbersList[phoneIndex].saleDate;
                }
            }
            
            appData.lots[lotId].sales.splice(index, 1);
            saveToFirebase();
            updateAll();
            showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }
    }

    // File handling - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞ initialize array
    document.getElementById('numberFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file || !currentLot) return;
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
        const fileNameDisplay = document.createElement('span');
        fileNameDisplay.style.cssText = 'color: #666; font-size: 14px; padding: 6px 12px; background: #f0f0f0; border-radius: 6px; margin-left: 10px;';
        const fileName = file.name.length > 30 ? file.name.substring(0, 27) + '...' : file.name;
        fileNameDisplay.textContent = `üìÑ ${fileName}`;
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≤‡∏á input (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
        const fileInput = document.getElementById('numberFileInput');
        const existingDisplay = fileInput.parentElement.querySelector('span');
        if (existingDisplay) {
            existingDisplay.remove();
        }
        fileInput.parentElement.appendChild(fileNameDisplay);
        
        const reader = new FileReader();
        reader.onload = function(event) {
            const content = event.target.result;
            const lines = content.split('\n');
            
            // Initialize numbersList ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° manual ‡∏Å‡πà‡∏≠‡∏ô)
            if (!appData.lots[currentLot].settings.numbersList) {
                appData.lots[currentLot].settings.numbersList = [];
            }
            
            let addedCount = 0;
            lines.forEach(line => {
                const parts = line.split(',');
                const number = parts[0].trim();
                const cost = parts.length > 1 ? parseFloat(parts[1]) : 0;
                const status = parts.length > 2 ? parts[2].trim() : 'available';
                const note = parts.length > 3 ? parts[3].trim() : '';
                
                if (number && number.length >= 9) {
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                    const exists = appData.lots[currentLot].settings.numbersList.find(
                        p => p.number === number
                    );
                    
                    if (!exists) {
                        appData.lots[currentLot].settings.numbersList.push({
                            number: number,
                            cost: cost,
                            status: status,
                            note: note
                        });
                        addedCount++;
                    }
                }
            });
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå
            appData.lots[currentLot].settings.totalNumbers = 
                appData.lots[currentLot].settings.numbersList.length;
            
            saveToFirebase();
            updatePhoneList();
            updateAll();
            showToast(`‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î ${addedCount} ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
            
            if (lines.length - addedCount > 0) {
                showToast(`‡∏°‡∏µ ${lines.length - addedCount} ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`, 'warning');
            }
        };
        reader.readAsText(file);
    });

    // Export/Import functions
    function exportToExcel() {
        const wb = XLSX.utils.book_new();
        
        // Summary sheet
        const summaryData = [
            ['‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•/‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ - Multi Lot'],
            ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å: ' + new Date().toLocaleDateString('th-TH')],
            ['']
        ];
        
        Object.keys(appData.lots).forEach(lotId => {
            const lot = appData.lots[lotId];
            const lotSales = lot.sales ? lot.sales.reduce((sum, s) => sum + s.price, 0) : 0;
            const lotSold = lot.sales ? lot.sales.length : 0;
            const lotProfit = lotSales - lot.settings.totalCost;
            const lotProfitMargin = lot.settings.totalCost > 0 ? 
                ((lotProfit / lot.settings.totalCost) * 100).toFixed(2) : 0;
            
            summaryData.push(
                [`Lot: ${lot.name}`],
                ['‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô', lot.settings.totalCost],
                ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', lot.settings.totalNumbers],
                ['‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', lotSold],
                ['‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°', lotSales],
                ['‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô', lotProfit],
                ['‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡∏•‡∏Å‡∏≥‡πÑ‡∏£', lotProfitMargin + '%'],
                ['']
            );
        });
        
        const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, ws1, '‡∏™‡∏£‡∏∏‡∏õ');
        
        // Sales sheets for each lot
        Object.keys(appData.lots).forEach(lotId => {
            const lot = appData.lots[lotId];
            if (lot.sales && lot.sales.length > 0) {
                const salesData = [['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏ö‡∏≠‡∏£‡πå', '‡∏£‡∏≤‡∏Ñ‡∏≤', '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']];
                lot.sales.forEach(sale => {
                    salesData.push([
                        sale.date,
                        sale.phoneNumber,
                        sale.price,
                        getChannelText(sale.channel),
                        sale.note || ''
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(salesData);
                XLSX.utils.book_append_sheet(wb, ws, lot.name);
            }
        });
        
        // Stock sheet
        const stockData = [['Lot', '‡πÄ‡∏ö‡∏≠‡∏£‡πå', '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']];
        Object.keys(appData.lots).forEach(lotId => {
            const lot = appData.lots[lotId];
            if (lot.settings.numbersList) {
                lot.settings.numbersList.forEach(phone => {
                    stockData.push([
                        lot.name,
                        phone.number,
                        phone.cost || 0,
                        phone.status === 'sold' ? '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : 
                        phone.status === 'reserved' ? '‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ß‡πà‡∏≤‡∏á',
                        phone.salePrice || '-',
                        phone.note || ''
                    ]);
                });
            }
        });
        
        const ws2 = XLSX.utils.aoa_to_sheet(stockData);
        XLSX.utils.book_append_sheet(wb, ws2, 'Stock');
        
        const today = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `phone_auction_v5_${today}.xlsx`);
        
        showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    // ‚ùå ‡∏•‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô exportToJSON() ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏õ

    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô backupData() ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    function backupData() {
        const dataStr = JSON.stringify(appData, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `phone_auction_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();

        URL.revokeObjectURL(url);
        showToast('üíæ Backup ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
    }

    function importData(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (imported.lots && typeof imported.lots === 'object') {
                        appData = imported;
                        currentLot = Object.keys(appData.lots)[0] || null;
                        
                        saveToFirebase();
                        updateAll();
                        showToast('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    } else {
                        showToast('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    }
                } catch (error) {
                    showToast('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                }
            };
            reader.readAsText(file);
        }
    }

    function exportInventory() {
        let numbers = [];
        if (currentLot && appData.lots[currentLot] && appData.lots[currentLot].settings.numbersList) {
            numbers = appData.lots[currentLot].settings.numbersList.map(phone => 
                `${phone.number},${phone.cost || 0},${phone.status},${phone.note || ''}`
            );
        }
        
        if (numbers.length === 0) {
            showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ Export', 'warning');
            return;
        }
        
        const content = numbers.join('\n');
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `inventory_${appData.lots[currentLot].name}_${new Date().toISOString().split('T')[0]}.txt`;
        link.click();
        
        showToast('Export ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    function clearAllData() {
        if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ')) {
            if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£!')) {
                // Clear all data
                appData = {
                    lots: {},
                    lastUpdate: null,
                    version: '5.0'
                };
                
                // Create default lot
                createDefaultLot();
                
                showToast('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            }
        }
    }

    // Utility functions
    function getChannelText(channel) {
        const channels = {
            'auction': '‡∏õ‡∏£‡∏∞‡∏°‡∏π‡∏•',
            'direct': '‡∏Ç‡∏≤‡∏¢‡∏ï‡∏£‡∏á',
            'online': '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå',
            'other': '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
        };
        return channels[channel] || channel;
    }

    function setToday() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('saleDate').value = today;
        document.getElementById('bulkDate').value = today;
        document.getElementById('fileDate').value = today;
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = document.getElementById('toastIcon');
        
        toast.className = 'toast ' + type;
        toastMessage.textContent = message;
        
        // Set icon based on type
        const icons = {
            'success': '‚úì',
            'error': '‚úï',
            'warning': '‚ö†',
            'info': '‚Ñπ'
        };
        toastIcon.textContent = icons[type] || '‚úì';
        
        toast.style.display = 'block';
        
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }

    // === Advanced Reports & Profit Analysis Class ===
    class AdvancedReports {
        static generateProfitAnalysis(specificLots = null) {
            const analysis = {
                overview: {},
                trends: [],
                kpis: {},
                predictions: {},
                lotPerformance: []
            };
            
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î lots ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            let lotsToAnalyze = [];
            
            if (specificLots) {
                // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ lots ‡∏°‡∏≤
                lotsToAnalyze = specificLots;
            } else if (multiSelectMode && selectedLots.length > 0) {
                // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î multi-select
                lotsToAnalyze = selectedLots;
            } else if (currentLot) {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å lot ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                lotsToAnalyze = [currentLot];
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏£ ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                lotsToAnalyze = Object.keys(appData.lots);
            }
            
            // Calculate Overview ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ lots ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            let totalRevenue = 0;
            let totalCost = 0;
            let totalNumbers = 0;
            let soldCount = 0;
            
            lotsToAnalyze.forEach(lotId => {
                const lot = appData.lots[lotId];
                if (!lot) return;
                
                const lotCost = lot.settings.totalCost || 0;
                const lotNumbers = lot.settings.totalNumbers || 0;
                const lotSales = lot.sales || [];
                const lotRevenue = lotSales.reduce((sum, sale) => sum + sale.price, 0);
                
                totalCost += lotCost;
                totalNumbers += lotNumbers;
                totalRevenue += lotRevenue;
                soldCount += lotSales.length;
                
                // Lot Performance
                const avgPrice = lotSales.length > 0 ? lotRevenue / lotSales.length : 0;
                const sellRate = lotNumbers > 0 ? (lotSales.length / lotNumbers * 100) : 0;
                const profitMargin = lotCost > 0 ? ((lotRevenue - lotCost) / lotCost * 100) : 0;
                
                analysis.lotPerformance.push({
                    name: lot.name,
                    revenue: lotRevenue,
                    cost: lotCost,
                    profit: lotRevenue - lotCost,
                    profitMargin: profitMargin.toFixed(2),
                    sellRate: sellRate.toFixed(2),
                    avgPrice: avgPrice,
                    totalNumbers: lotNumbers,
                    soldCount: lotSales.length,
                    remaining: lotNumbers - lotSales.length
                });
            });
            
            // Calculate KPIs
            const grossProfit = totalRevenue - totalCost;
            const grossProfitMargin = totalCost > 0 ? (grossProfit / totalCost * 100) : 0;
            const avgSellingPrice = soldCount > 0 ? totalRevenue / soldCount : 0;
            const avgCostPerNumber = totalNumbers > 0 ? totalCost / totalNumbers : 0;
            const overallSellRate = totalNumbers > 0 ? (soldCount / totalNumbers * 100) : 0;
            const roi = totalCost > 0 ? (grossProfit / totalCost * 100) : 0;
            
            analysis.overview = {
                totalRevenue,
                totalCost,
                grossProfit,
                grossProfitMargin: grossProfitMargin.toFixed(2),
                totalNumbers,
                soldCount,
                remaining: totalNumbers - soldCount,
                selectedLots: lotsToAnalyze.map(id => appData.lots[id]?.name || id).join(', ')
            };
            
            analysis.kpis = {
                avgSellingPrice: avgSellingPrice.toFixed(0),
                avgCostPerNumber: avgCostPerNumber.toFixed(0),
                overallSellRate: overallSellRate.toFixed(2),
                roi: roi.toFixed(2),
                profitPerSale: soldCount > 0 ? (grossProfit / soldCount).toFixed(0) : 0
            };
            
            // Calculate Daily Trends (last 30 days) ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ lots ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const dailySales = {};
            lotsToAnalyze.forEach(lotId => {
                const lot = appData.lots[lotId];
                if (lot && lot.sales) {
                    lot.sales.forEach(sale => {
                        if (!dailySales[sale.date]) {
                            dailySales[sale.date] = {
                                revenue: 0,
                                count: 0
                            };
                        }
                        dailySales[sale.date].revenue += sale.price;
                        dailySales[sale.date].count += 1;
                    });
                }
            });
            
            const sortedDates = Object.keys(dailySales).sort().slice(-30);
            analysis.trends = sortedDates.map(date => ({
                date,
                revenue: dailySales[date].revenue,
                count: dailySales[date].count,
                avgPrice: dailySales[date].revenue / dailySales[date].count
            }));
            
            // Predictions (Simple Linear Regression)
            if (analysis.trends.length >= 7) {
                const recentTrend = analysis.trends.slice(-7);
                const avgDailyRevenue = recentTrend.reduce((sum, day) => sum + day.revenue, 0) / 7;
                const avgDailySales = recentTrend.reduce((sum, day) => sum + day.count, 0) / 7;
                
                analysis.predictions = {
                    next7Days: {
                        revenue: (avgDailyRevenue * 7).toFixed(0),
                        sales: Math.round(avgDailySales * 7)
                    },
                    next30Days: {
                        revenue: (avgDailyRevenue * 30).toFixed(0),
                        sales: Math.round(avgDailySales * 30)
                    },
                    breakEvenPoint: totalCost > 0 && avgSellingPrice > 0 ? 
                        Math.ceil((totalCost - totalRevenue) / avgSellingPrice) : 0
                };
            }
            
            return analysis;
        }
        
        static generateMonthlySalesReport(specificLots = null) {
            const monthlyData = {};
            
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î lots ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
            let lotsToAnalyze = [];
            
            if (specificLots) {
                lotsToAnalyze = specificLots;
            } else if (multiSelectMode && selectedLots.length > 0) {
                lotsToAnalyze = selectedLots;
            } else if (currentLot) {
                lotsToAnalyze = [currentLot];
            } else {
                lotsToAnalyze = Object.keys(appData.lots);
            }
            
            lotsToAnalyze.forEach(lotId => {
                const lot = appData.lots[lotId];
                if (lot && lot.sales) {
                    lot.sales.forEach(sale => {
                        const date = new Date(sale.date);
                        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        
                        if (!monthlyData[monthKey]) {
                            monthlyData[monthKey] = {
                                revenue: 0,
                                count: 0,
                                lots: {}
                            };
                        }
                        
                        monthlyData[monthKey].revenue += sale.price;
                        monthlyData[monthKey].count += 1;
                        
                        if (!monthlyData[monthKey].lots[lot.name]) {
                            monthlyData[monthKey].lots[lot.name] = {
                                revenue: 0,
                                count: 0
                            };
                        }
                        monthlyData[monthKey].lots[lot.name].revenue += sale.price;
                        monthlyData[monthKey].lots[lot.name].count += 1;
                    });
                }
            });
            
            return monthlyData;
        }
        
        static exportAdvancedPDF() {
            const analysis = this.generateProfitAnalysis(); // ‡πÉ‡∏ä‡πâ default = lot ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà
            
            // Update PDF header
            document.getElementById('pdfReportType').textContent = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á';
            document.getElementById('pdfDate').textContent = new Date().toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('pdfLotName').textContent = `Lot: ${analysis.overview.selectedLots}`;
            document.getElementById('pdfTimestamp').textContent = new Date().toLocaleString('th-TH');
            
            // Print
            window.print();
        }
    }

    // Enhanced Print Daily Report with Beautiful PDF
    function printDailyReportEnhanced() {
        const selectedDate = document.getElementById('reportDate').value;
        if (!selectedDate) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô', 'warning');
            return;
        }
        
        // Update report first
        updateDailyReport();
        
        // Wait for DOM update
        setTimeout(() => {
            const dailySales = getSalesByDate(selectedDate);
            if (dailySales.length === 0) {
                showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'warning');
                return;
            }
            
            // Group by lot for header
            const lotsInReport = {};
            let totalRevenue = 0;
            
            dailySales.forEach(sale => {
                if (!lotsInReport[sale.lotId]) {
                    lotsInReport[sale.lotId] = sale.lotName;
                }
                totalRevenue += sale.price;
            });
            
            const lotNames = Object.values(lotsInReport).join(', ');
            
            // Update PDF header
            document.getElementById('pdfReportType').textContent = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô';
            document.getElementById('pdfDate').textContent = formatDate(selectedDate);
            document.getElementById('pdfLotName').textContent = `Lot: ${lotNames}`;
            document.getElementById('pdfTimestamp').textContent = new Date().toLocaleString('th-TH');
            
            // Create print-specific content
            const printContent = createDailyReportPrintContent(selectedDate, dailySales, totalRevenue);
            
            // Add print content to page temporarily
            const printDiv = document.createElement('div');
            printDiv.id = 'printOnlyContent';
            printDiv.className = 'print-only-content';
            printDiv.innerHTML = printContent;
            document.body.appendChild(printDiv);
            
            // Add print class
            document.body.classList.add('printing-daily-report');
            
            // Print
            setTimeout(() => {
                window.print();
                
                // Clean up after printing
                setTimeout(() => {
                    document.body.classList.remove('printing-daily-report');
                    const tempPrint = document.getElementById('printOnlyContent');
                    if (tempPrint) {
                        tempPrint.remove();
                    }
                }, 500);
            }, 100);
        }, 200);
    }

    // Create printable content for daily report
    function createDailyReportPrintContent(selectedDate, dailySales, totalRevenue) {
        // Group sales by lot
        const salesByLot = {};
        
        dailySales.forEach(sale => {
            if (!salesByLot[sale.lotId]) {
                salesByLot[sale.lotId] = {
                    lotName: sale.lotName,
                    sales: [],
                    total: 0,
                    count: 0
                };
            }
            salesByLot[sale.lotId].sales.push(sale);
            salesByLot[sale.lotId].total += sale.price;
            salesByLot[sale.lotId].count += 1;
        });
        
        const avgPrice = totalRevenue / dailySales.length;
        
        // Build HTML content
        let html = `
            <div class="daily-report-container">
                <!-- Summary Cards -->
                <div class="summary-grid" style="margin-bottom: 30px;">
                    <div class="summary-card">
                        <h3>üí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h3>
                        <div class="value">${formatNumber(totalRevenue)}</div>
                        <div class="subtitle">‡∏ö‡∏≤‡∏ó</div>
                    </div>
                    <div class="summary-card">
                        <h3>üì± ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå</h3>
                        <div class="value">${dailySales.length}</div>
                        <div class="subtitle">‡πÄ‡∏ö‡∏≠‡∏£‡πå</div>
                    </div>
                    <div class="summary-card">
                        <h3>üìä ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h3>
                        <div class="value">${formatNumber(avgPrice)}</div>
                        <div class="subtitle">‡∏ö‡∏≤‡∏ó/‡πÄ‡∏ö‡∏≠‡∏£‡πå</div>
                    </div>
                </div>
                
                <!-- Phone Lists by Lot -->
                <h3 style="margin-bottom: 20px;">üì± ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</h3>
        `;
        
        // Add each lot section
        Object.entries(salesByLot).forEach(([lotId, lotData]) => {
            html += `
                <div class="lot-section">
                    <div class="lot-section-header">
                        üì¶ ${lotData.lotName} (${lotData.count} ‡πÄ‡∏ö‡∏≠‡∏£‡πå)
                    </div>
                    <div class="lot-summary">
                        <div class="lot-summary-item">
                            <div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div>
                            <div class="value">${lotData.count}</div>
                        </div>
                        <div class="lot-summary-item">
                            <div class="label">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</div>
                            <div class="value">${formatNumber(lotData.total)}</div>
                        </div>
                        <div class="lot-summary-item">
                            <div class="label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                            <div class="value">${formatNumber(lotData.total / lotData.count)}</div>
                        </div>
                        <div class="lot-summary-item">
                            <div class="label">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</div>
                            <div class="value">${((lotData.total / totalRevenue) * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                    <div class="daily-phones-grid">
            `;
            
            lotData.sales.forEach(sale => {
                html += `
                    <div class="daily-phone-item ${sale.price >= 1000 ? 'highlight' : ''}">
                        <div style="font-weight: bold;">${sale.phoneNumber || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                        <div style="color: #059669; font-size: 9pt;">‡∏ø${formatNumber(sale.price)}</div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        // Add total summary
        html += `
                <div class="daily-summary-total">
                    <div style="font-size: 16pt; font-weight: bold;">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    <div style="font-size: 24pt; margin: 10px 0;">‡∏ø${formatNumber(totalRevenue)}</div>
                    <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${dailySales.length} ‡πÄ‡∏ö‡∏≠‡∏£‡πå | ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏ø${formatNumber(avgPrice)}/‡πÄ‡∏ö‡∏≠‡∏£‡πå</div>
                </div>
                
                <!-- Detail Table -->
                <div class="page-break"></div>
                <h3 style="margin: 20px 0;">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                            <th>Lot</th>
                            <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                            <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                            <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Add table rows by lot
        let rowIndex = 1;
        Object.entries(salesByLot).forEach(([lotId, lotData]) => {
            // Lot header row
            html += `
                <tr style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white;">
                    <td colspan="6" style="padding: 10px; font-weight: bold;">
                        üì¶ ${lotData.lotName} - ‡∏£‡∏ß‡∏° ${lotData.count} ‡πÄ‡∏ö‡∏≠‡∏£‡πå | ‡∏ø${formatNumber(lotData.total)}
                    </td>
                </tr>
            `;
            
            // Sales rows
            lotData.sales.forEach(sale => {
                html += `
                    <tr>
                        <td>${rowIndex++}</td>
                        <td>${sale.lotName}</td>
                        <td>${sale.phoneNumber || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
                        <td style="text-align: right;">${formatNumber(sale.price)}</td>
                        <td>${getChannelText(sale.channel)}</td>
                        <td>${sale.note || '-'}</td>
                    </tr>
                `;
            });
            
            // Subtotal row
            html += `
                <tr style="background: #f9fafb;">
                    <td colspan="3" style="text-align: right; font-weight: bold;">‡∏£‡∏ß‡∏° ${lotData.lotName}:</td>
                    <td style="font-weight: bold; text-align: right; color: #059669;">‡∏ø${formatNumber(lotData.total)}</td>
                    <td colspan="2"></td>
                </tr>
            `;
        });
        
        // Grand total row
        html += `
                    <tr style="background: #10b981; color: white;">
                        <td colspan="3" style="text-align: right; font-weight: bold; font-size: 14pt;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</td>
                        <td style="font-weight: bold; text-align: right; font-size: 14pt;">‡∏ø${formatNumber(totalRevenue)}</td>
                        <td colspan="2" style="text-align: center;">${dailySales.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
                    </tr>
                </tbody>
            </table>
        </div>
        `;
        
        return html;
    }

    // Show Advanced Reports Modal
    function showAdvancedReports() {
        const analysis = AdvancedReports.generateProfitAnalysis(); // ‡∏à‡∏∞‡πÉ‡∏ä‡πâ lot ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠ Lots ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á
        let displayLots = '';
        if (multiSelectMode && selectedLots.length > 0) {
            displayLots = selectedLots.map(id => appData.lots[id]?.name || id).join(', ');
        } else if (currentLot) {
            displayLots = appData.lots[currentLot]?.name || currentLot;
        } else {
            displayLots = '‡∏ó‡∏∏‡∏Å Lot';
        }
        
        // Create modal content
        const modalContent = `
            <div class="modal" id="advancedReportModal" style="display: block;">
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≥‡πÑ‡∏£ - ${displayLots}</h3>
                        <button class="close" onclick="document.getElementById('advancedReportModal').remove()">√ó</button>
                    </div>
                    
                    <div class="tabs" style="margin: 20px 0;">
                        <button class="tab-btn active" onclick="showReportTab('overview')">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
                        <button class="tab-btn" onclick="showReportTab('kpis')">KPIs</button>
                        <button class="tab-btn" onclick="showReportTab('trends')">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</button>
                        <button class="tab-btn" onclick="showReportTab('predictions')">‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå</button>
                        <button class="tab-btn" onclick="showReportTab('performance')">‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</button>
                    </div>
                    
                    <div id="report-overview" class="report-tab-content">
                        <div class="summary-grid">
                            <div class="summary-card">
                                <h3>üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</h3>
                                <div class="value">${analysis.overview.totalRevenue.toLocaleString()}</div>
                                <div class="subtitle">‡∏à‡∏≤‡∏Å ${analysis.overview.soldCount} ‡πÄ‡∏ö‡∏≠‡∏£‡πå</div>
                            </div>
                            <div class="summary-card">
                                <h3>üìä ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</h3>
                                <div class="value" style="color: ${analysis.overview.grossProfit >= 0 ? '#10b981' : '#ef4444'}">
                                    ${analysis.overview.grossProfit.toLocaleString()}
                                </div>
                                <div class="subtitle">Margin ${analysis.overview.grossProfitMargin}%</div>
                            </div>
                            <div class="summary-card">
                                <h3>üì¶ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3>
                                <div class="value">${analysis.overview.remaining}</div>
                                <div class="subtitle">‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${analysis.overview.totalNumbers} ‡πÄ‡∏ö‡∏≠‡∏£‡πå</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="report-kpis" class="report-tab-content" style="display: none;">
                        <div class="summary-grid">
                            <div class="summary-card">
                                <h3>üíµ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h3>
                                <div class="value">${analysis.kpis.avgSellingPrice}</div>
                                <div class="subtitle">‡∏ö‡∏≤‡∏ó/‡πÄ‡∏ö‡∏≠‡∏£‡πå</div>
                            </div>
                            <div class="summary-card">
                                <h3>üéØ ROI</h3>
                                <div class="value" style="color: ${analysis.kpis.roi >= 0 ? '#10b981' : '#ef4444'}">
                                    ${analysis.kpis.roi}%
                                </div>
                                <div class="subtitle">‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô</div>
                            </div>
                            <div class="summary-card">
                                <h3>üìä ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
                                <div class="value">${analysis.kpis.overallSellRate}%</div>
                                <div class="subtitle">‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ ${analysis.overview.soldCount}/${analysis.overview.totalNumbers}</div>
                            </div>
                        </div>
                        <div class="summary-grid" style="margin-top: 20px;">
                            <div class="summary-card">
                                <h3>üí∏ ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h3>
                                <div class="value">${analysis.kpis.avgCostPerNumber}</div>
                                <div class="subtitle">‡∏ö‡∏≤‡∏ó/‡πÄ‡∏ö‡∏≠‡∏£‡πå</div>
                            </div>
                            <div class="summary-card">
                                <h3>üíπ ‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
                                <div class="value">${analysis.kpis.profitPerSale}</div>
                                <div class="subtitle">‡∏ö‡∏≤‡∏ó/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                            </div>
                            <div class="summary-card">
                                <h3>üìà ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</h3>
                                <div class="value">${analysis.overview.totalCost.toLocaleString()}</div>
                                <div class="subtitle">‡∏ö‡∏≤‡∏ó</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="report-trends" class="report-tab-content" style="display: none;">
                        <h4>üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                        <th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
                                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢</th>
                                        <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${analysis.trends.map(day => `
                                        <tr>
                                            <td>${formatDate(day.date)}</td>
                                            <td>${day.revenue.toLocaleString()}</td>
                                            <td>${day.count}</td>
                                            <td>${Math.round(day.avgPrice).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="report-predictions" class="report-tab-content" style="display: none;">
                        ${analysis.predictions.next7Days ? `
                            <div class="summary-grid">
                                <div class="summary-card">
                                    <h3>üìÖ ‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå 7 ‡∏ß‡∏±‡∏ô</h3>
                                    <div class="value">${parseInt(analysis.predictions.next7Days.revenue).toLocaleString()}</div>
                                    <div class="subtitle">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (${analysis.predictions.next7Days.sales} ‡πÄ‡∏ö‡∏≠‡∏£‡πå)</div>
                                </div>
                                <div class="summary-card">
                                    <h3>üìÜ ‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå 30 ‡∏ß‡∏±‡∏ô</h3>
                                    <div class="value">${parseInt(analysis.predictions.next30Days.revenue).toLocaleString()}</div>
                                    <div class="subtitle">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (${analysis.predictions.next30Days.sales} ‡πÄ‡∏ö‡∏≠‡∏£‡πå)</div>
                                </div>
                                <div class="summary-card">
                                    <h3>üéØ ‡∏à‡∏∏‡∏î‡∏Ñ‡∏∏‡πâ‡∏°‡∏ó‡∏∏‡∏ô</h3>
                                    <div class="value">${analysis.predictions.breakEvenPoint}</div>
                                    <div class="subtitle">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°</div>
                                </div>
                            </div>
                        ` : '<p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô)</p>'}
                    </div>
                    
                    <div id="report-performance" class="report-tab-content" style="display: none;">
                        <h4>üèÜ ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÅ‡∏ï‡πà‡∏•‡∏∞ Lot</h4>
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Lot</th>
                                    <th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
                                    <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th>
                                    <th>‡∏Å‡∏≥‡πÑ‡∏£</th>
                                    <th>Margin</th>
                                    <th>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${analysis.lotPerformance.map(lot => `
                                    <tr>
                                        <td>${lot.name}</td>
                                        <td>${lot.revenue.toLocaleString()}</td>
                                        <td>${lot.cost.toLocaleString()}</td>
                                        <td style="color: ${lot.profit >= 0 ? '#10b981' : '#ef4444'}">
                                            ${lot.profit.toLocaleString()}
                                        </td>
                                        <td>${lot.profitMargin}%</td>
                                        <td>${lot.sellRate}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="button-group" style="margin-top: 24px;">
                        <button class="btn btn-primary" onclick="AdvancedReports.exportAdvancedPDF()">
                            üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå PDF
                        </button>
                        <button class="btn btn-success" onclick="exportAdvancedExcel()">
                            üìä Export Excel
                        </button>
                        <button class="btn btn-info" onclick="showAdvancedReportsAll()">
                            üåê ‡∏î‡∏π‡∏ó‡∏∏‡∏Å Lot
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Add to body
        const existingModal = document.getElementById('advancedReportModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        const div = document.createElement('div');
        div.innerHTML = modalContent;
        document.body.appendChild(div);
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏ó‡∏∏‡∏Å Lot
    function showAdvancedReportsAll() {
        document.getElementById('advancedReportModal').remove();
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ
        const oldMultiSelect = multiSelectMode;
        const oldSelected = [...selectedLots];
        const oldCurrent = currentLot;
        
        // Reset ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        multiSelectMode = false;
        selectedLots = [];
        currentLot = null;
        
        // ‡πÅ‡∏™‡∏î‡∏á report ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        showAdvancedReports();
        
        // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
        multiSelectMode = oldMultiSelect;
        selectedLots = oldSelected;
        currentLot = oldCurrent;
    }

    // Tab switching for reports
    function showReportTab(tabName) {
        document.querySelectorAll('.report-tab-content').forEach(tab => {
            tab.style.display = 'none';
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        const tab = document.getElementById(`report-${tabName}`);
        if (tab) {
            tab.style.display = 'block';
            event.target.classList.add('active');
        }
    }

    // Export Advanced Excel Report
    function exportAdvancedExcel() {
        const analysis = AdvancedReports.generateProfitAnalysis(); // ‡πÉ‡∏ä‡πâ lot ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà
        const wb = XLSX.utils.book_new();
        
        // Overview Sheet
        const overviewData = [
            ['‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á'],
            ['Lot ‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', analysis.overview.selectedLots],
            ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', new Date().toLocaleDateString('th-TH')],
            [''],
            ['‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°'],
            ['‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°', analysis.overview.totalRevenue],
            ['‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°', analysis.overview.totalCost],
            ['‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', analysis.overview.grossProfit],
            ['Profit Margin %', analysis.overview.grossProfitMargin],
            ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', analysis.overview.totalNumbers],
            ['‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', analysis.overview.soldCount],
            ['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', analysis.overview.remaining],
            [''],
            ['KPIs'],
            ['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢', analysis.kpis.avgSellingPrice],
            ['‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå', analysis.kpis.avgCostPerNumber],
            ['ROI %', analysis.kpis.roi],
            ['‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ %', analysis.kpis.overallSellRate],
            ['‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢', analysis.kpis.profitPerSale]
        ];
        
        const ws1 = XLSX.utils.aoa_to_sheet(overviewData);
        XLSX.utils.book_append_sheet(wb, ws1, '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°');
        
        // Lot Performance Sheet
        if (analysis.lotPerformance.length > 0) {
            const perfData = [
                ['Lot', '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ', '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô', '‡∏Å‡∏≥‡πÑ‡∏£', 'Margin %', '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ç‡∏≤‡∏¢ %', '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢', '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']
            ];
            
            analysis.lotPerformance.forEach(lot => {
                perfData.push([
                    lot.name,
                    lot.revenue,
                    lot.cost,
                    lot.profit,
                    lot.profitMargin,
                    lot.sellRate,
                    Math.round(lot.avgPrice),
                    lot.soldCount,
                    lot.remaining
                ]);
            });
            
            const ws2 = XLSX.utils.aoa_to_sheet(perfData);
            XLSX.utils.book_append_sheet(wb, ws2, '‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û Lot');
        }
        
        // Trends Sheet
        if (analysis.trends.length > 0) {
            const trendData = [
                ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢', '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢']
            ];
            
            analysis.trends.forEach(day => {
                trendData.push([
                    day.date,
                    day.revenue,
                    day.count,
                    Math.round(day.avgPrice)
                ]);
            });
            
            const ws3 = XLSX.utils.aoa_to_sheet(trendData);
            XLSX.utils.book_append_sheet(wb, ws3, '‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° 30 ‡∏ß‡∏±‡∏ô');
        }
        
        // Export
        const lotName = analysis.overview.selectedLots.replace(/[^a-zA-Z0-9‡∏Å-‡πô]/g, '_');
        XLSX.writeFile(wb, `advanced_report_${lotName}_${new Date().toISOString().split('T')[0]}.xlsx`);
        showToast('Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    // === Performance Dashboard Functions ===
    function updatePerformanceDashboard() {
        const performanceData = calculatePerformanceData();
        
        // Update Traffic Light Cards
        updatePerformanceCards(performanceData);
        
        // Update Comparison Chart
        updateComparisonChart(performanceData);
        
        // Update Summary Table
        updatePerformanceTable(performanceData);
    }

    function calculatePerformanceData() {
        const data = [];
        
        Object.entries(appData.lots).forEach(([lotId, lot]) => {
            const cost = lot.settings.totalCost || 0;
            const totalNumbers = lot.settings.totalNumbers || 0;
            const sales = lot.sales || [];
            const revenue = sales.reduce((sum, sale) => sum + sale.price, 0);
            const profit = revenue - cost;
            const roi = cost > 0 ? ((profit / cost) * 100) : 0;
            const sellRate = totalNumbers > 0 ? ((sales.length / totalNumbers) * 100) : 0;
            const avgPrice = sales.length > 0 ? (revenue / sales.length) : 0;
            
            // Determine status
            let status = 'loss';
            let statusIcon = 'üî¥';
            let statusText = '‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô';
            
            if (roi > 30) {
                status = 'high';
                statusIcon = 'üü¢';
                statusText = '‡∏Å‡∏≥‡πÑ‡∏£‡∏î‡∏µ‡∏°‡∏≤‡∏Å';
            } else if (roi > 10) {
                status = 'medium';
                statusIcon = 'üü°';
                statusText = '‡∏Å‡∏≥‡πÑ‡∏£‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
            } else if (roi > 0) {
                status = 'low';
                statusIcon = 'üü†';
                statusText = '‡∏Å‡∏≥‡πÑ‡∏£‡∏ô‡πâ‡∏≠‡∏¢';
            }
            
            data.push({
                lotId,
                name: lot.name,
                cost,
                revenue,
                profit,
                roi,
                sellRate,
                avgPrice,
                totalNumbers,
                soldCount: sales.length,
                remaining: totalNumbers - sales.length,
                status,
                statusIcon,
                statusText,
                maxValue: Math.max(cost, revenue) // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö scale bar chart
            });
        });
        
        // Sort by ROI
        data.sort((a, b) => b.roi - a.roi);
        
        return data;
    }

    function updatePerformanceCards(data) {
        const container = document.getElementById('performanceCards');
        if (!container) return;
        
        container.innerHTML = '';
        
        data.forEach((lot, index) => {
            const card = document.createElement('div');
            card.className = `performance-card profit-${lot.status}`;
            
            const maxBarValue = Math.max(lot.cost, lot.revenue, Math.abs(lot.profit));
            
            card.innerHTML = `
                <div class="traffic-light">${lot.statusIcon}</div>
                <div class="performance-card-header">
                    <div class="performance-card-title">
                        ${index === 0 ? 'üëë ' : ''}${lot.name}
                    </div>
                    <div style="font-size: 14px; color: #6b7280;">
                        ${lot.statusText}
                    </div>
                </div>
                
                <div class="performance-bars">
                    <div class="performance-bar">
                        <div class="performance-bar-label">
                            <span>üí∞ ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</span>
                            <span>${lot.cost.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                        </div>
                        <div class="performance-bar-track">
                            <div class="performance-bar-fill cost" style="width: ${(lot.cost / maxBarValue) * 100}%">
                                ${((lot.cost / maxBarValue) * 100).toFixed(0)}%
                            </div>
                        </div>
                    </div>
                    
                    <div class="performance-bar">
                        <div class="performance-bar-label">
                            <span>üíµ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</span>
                            <span>${lot.revenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                        </div>
                        <div class="performance-bar-track">
                            <div class="performance-bar-fill revenue" style="width: ${(lot.revenue / maxBarValue) * 100}%">
                                ${((lot.revenue / maxBarValue) * 100).toFixed(0)}%
                            </div>
                        </div>
                    </div>
                    
                    <div class="performance-bar">
                        <div class="performance-bar-label">
                            <span>${lot.profit >= 0 ? 'üìà ‡∏Å‡∏≥‡πÑ‡∏£' : 'üìâ ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô'}</span>
                            <span>${lot.profit.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                        </div>
                        <div class="performance-bar-track">
                            <div class="performance-bar-fill profit" 
                                style="width: ${(Math.abs(lot.profit) / maxBarValue) * 100}%; 
                                        background: ${lot.profit >= 0 ? 
                                            'linear-gradient(135deg, #10b981 0%, #34d399 100%)' : 
                                            'linear-gradient(135deg, #ef4444 0%, #f87171 100%)'}">
                                ${lot.roi.toFixed(1)}%
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-metrics">
                    <div class="metric-item">
                        <div class="metric-label">ROI</div>
                        <div class="metric-value ${lot.roi >= 0 ? 'positive' : 'negative'}">
                            ${lot.roi >= 0 ? '+' : ''}${lot.roi.toFixed(1)}%
                        </div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ç‡∏≤‡∏¢</div>
                        <div class="metric-value neutral">
                            ${lot.sellRate.toFixed(1)}%
                        </div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
                        <div class="metric-value neutral">
                            ${lot.soldCount}/${lot.totalNumbers}
                        </div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                        <div class="metric-value neutral">
                            ${Math.round(lot.avgPrice).toLocaleString()}
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(card);
        });
    }

    function updateComparisonChart(data) {
        const ctx = document.getElementById('comparisonChart');
        if (!ctx) return;
        
        // Destroy existing chart
        if (window.comparisonChartInstance) {
            window.comparisonChartInstance.destroy();
        }
        
        const labels = data.map(d => d.name);
        
        window.comparisonChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô',
                        data: data.map(d => d.cost),
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 2
                    },
                    {
                        label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢',
                        data: data.map(d => d.revenue),
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2
                    },
                    {
                        label: '‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô',
                        data: data.map(d => d.profit),
                        backgroundColor: data.map(d => 
                            d.profit >= 0 ? 'rgba(251, 191, 36, 0.8)' : 'rgba(239, 68, 68, 0.8)'
                        ),
                        borderColor: data.map(d => 
                            d.profit >= 0 ? 'rgba(251, 191, 36, 1)' : 'rgba(239, 68, 68, 1)'
                        ),
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'üìä ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ó‡∏∏‡∏Å Lot',
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                if (context.datasetIndex === 2) { // ‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô
                                    const roi = data[context.dataIndex].roi;
                                    return `ROI: ${roi.toFixed(1)}%`;
                                }
                                return '';
                            }
                        }
                    },
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' ‡∏ø';
                            }
                        }
                    }
                }
            }
        });
    }

    function updatePerformanceTable(data) {
        const tbody = document.getElementById('performanceTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        data.forEach((lot, index) => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>
                    ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : (index + 1)}
                </td>
                <td><strong>${lot.name}</strong></td>
                <td>${lot.cost.toLocaleString()}</td>
                <td>${lot.revenue.toLocaleString()}</td>
                <td style="color: ${lot.profit >= 0 ? '#10b981' : '#ef4444'}; font-weight: bold;">
                    ${lot.profit >= 0 ? '+' : ''}${lot.profit.toLocaleString()}
                </td>
                <td>
                    <span style="padding: 4px 8px; border-radius: 12px; 
                        background: ${lot.roi > 30 ? '#d1fae5' : lot.roi > 0 ? '#fed7aa' : '#fee2e2'};
                        color: ${lot.roi > 30 ? '#065f46' : lot.roi > 0 ? '#92400e' : '#991b1b'};">
                        ${lot.roi.toFixed(1)}%
                    </span>
                </td>
                <td>${lot.sellRate.toFixed(1)}%</td>
                <td>${lot.statusIcon} ${lot.statusText}</td>
            `;
        });
    }

    // Window click event to close modals
    window.onclick = function(event) {
        if (event.target.className === 'modal') {
            event.target.style.display = 'none';
            editingIndex = -1;
            editingLot = null;
            editingPhoneLot = null;
            editingPhoneIndex = -1;
        }
    }

    // Prevent closing when Firebase sync is in progress
    window.addEventListener('beforeunload', (e) => {
        if (isOnline) {
            return null;
        }
        e.preventDefault();
        e.returnValue = '';
    });

    // Helper Functions
    function formatNumber(num) {
        return parseInt(num).toLocaleString('th-TH');
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        const months = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', 
                    '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
        const day = date.getDate();
        const month = months[date.getMonth()];
        const year = date.getFullYear() + 543; // ‡∏õ‡∏µ ‡∏û.‡∏®.
        return `${day} ${month} ${year}`;
    }
</script>

</body>
</html>